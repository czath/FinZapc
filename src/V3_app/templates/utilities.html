{% extends "base.html" %}

{% block title %}Utilities - {{ super() }}{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<!-- jsPDF and html2canvas removed -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
<style>
  .utility-section {
    padding: 20px;
    margin-bottom: 30px;
    border-radius: 8px;
    /* background-color: var(--bs-card-bg); */ /* Will be part of tab-pane or card within tab-pane */
    /* box-shadow: 0 2px 4px rgba(0,0,0,0.1); */ /* Will be part of tab-pane or card within tab-pane */
  }
  .utility-section h2 {
    margin-bottom: 20px;
    color: var(--bs-heading-color);
  }
  #atrResult {
    margin-top: 15px;
    padding: 10px;
    border-radius: 4px;
  }
  #atrResult.success {
    background-color: var(--bs-success-bg-subtle, #d1e7dd);
    border-color: var(--bs-success-border-subtle, #badbcc);
    color: var(--bs-success-text-emphasis, #0a3622);
  }
  #atrResult.error {
    background-color: var(--bs-danger-bg-subtle, #f8d7da);
    border-color: var(--bs-danger-border-subtle, #f5c2c7);
    color: var(--bs-danger-text-emphasis, #58151c);
  }
  /* Ensure tab panes have some padding if sections are removed */
  .tab-pane {
      padding-top: 20px; /* Add some space below the tabs */
  }
  /* Styles for unclean rows */
  .cumulative-row td,
  .redundant-row td,
  .superseded-row td {
    color: #777 !important; /* Lighter text color */
    font-style: italic !important;
  }
  .cumulative-row,
  .redundant-row,
  .superseded-row {
    background-color: #f8f9fa !important; /* Slightly different background */
  }

  /* Styles for table sorting indicators */
  /* DataTables will handle its own sort indicators. */

  /* Reduce font size for EDGAR concept list items (Label only) */
  #edgarConceptList .form-check-label {
    font-size: 0.875rem; /* Apply desired font size directly to the label */
    font-weight: normal; /* Ensure label text is not bold */
  }

  /* Styles for LLM Report Output */
  #llmReportOutput {
    background-color: var(--bs-tertiary-bg);
    color: var(--bs-body-color);
    font-family: var(--bs-font-sans-serif);
    white-space: normal; /* Allow text to wrap naturally */
    border: 1px solid var(--bs-border-color);
    border-radius: .375rem;
    padding: 1rem;
  }
  #llmReportOutput h1, #llmReportOutput h2, #llmReportOutput h3, #llmReportOutput h4 {
    color: var(--bs-heading-color);
    margin-top: 1em;
    margin-bottom: 0.5em;
  }
  #llmReportOutput h1 { font-size: 1.75rem; }
  #llmReportOutput h2 { font-size: 1.5rem; }
  #llmReportOutput h3 { font-size: 1.25rem; }
  #llmReportOutput p {
    margin-bottom: 1rem;
    line-height: 1.6;
  }
  #llmReportOutput ul, #llmReportOutput ol {
    padding-left: 2em;
    margin-bottom: 1rem;
  }
  #llmReportOutput code {
    background-color: var(--bs-secondary-bg);
    padding: .2em .4em;
    font-size: 85%;
    border-radius: 6px;
  }
  #llmReportOutput pre {
    background-color: var(--bs-secondary-bg);
    padding: 1rem;
    border-radius: 6px;
    white-space: pre-wrap;
    word-break: break-all;
  }
  #llmReportOutput blockquote {
    border-left: 4px solid var(--bs-border-color);
    padding-left: 1rem;
    color: var(--bs-secondary-color);
    margin-left: 0;
  }

  /* Styles for chat messages */
  .llm-chat-message {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    max-width: 90%;
  }

  .llm-chat-message.user-message {
    background-color: var(--bs-primary-bg-subtle);
    border: 1px solid var(--bs-primary-border-subtle);
    margin-left: auto;
    text-align: left;
  }

  .llm-chat-message.model-message {
    background-color: var(--bs-tertiary-bg);
    border: 1px solid var(--bs-border-color);
    margin-right: auto;
    text-align: left;
  }
  .llm-chat-message h1, .llm-chat-message h2, .llm-chat-message h3 {
      margin-top: 0.5rem;
  }


</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Utilities</h1>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" id="utilitiesTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="atr-tab" data-bs-toggle="tab" data-bs-target="#atr-tab-pane" type="button" role="tab" aria-controls="atr-tab-pane" aria-selected="true">ATR Calculator</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="edgar-tab" data-bs-toggle="tab" data-bs-target="#edgar-tab-pane" type="button" role="tab" aria-controls="edgar-tab-pane" aria-selected="false">EDGAR Browser</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="datalcm-tab" data-bs-toggle="tab" data-bs-target="#datalcm-tab-pane" type="button" role="tab" aria-controls="datalcm-tab-pane" aria-selected="false">Data LCM</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="llm-analytics-tab" data-bs-toggle="tab" data-bs-target="#llm-analytics-tab-pane" type="button" role="tab" aria-controls="llm-analytics-tab-pane" aria-selected="false">AI Assistant</button>
        </li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content" id="utilitiesTabContent">
        <!-- ATR Calculator Tab Pane -->
        <div class="tab-pane fade show active utility-section" id="atr-tab-pane" role="tabpanel" aria-labelledby="atr-tab" tabindex="0">
            <div class="card">
        <div class="card-header">
            <h2>ATR Calculator</h2>
        </div>
        <div class="card-body">
            <form id="atrCalculatorForm">
                <div class="mb-3">
                    <label for="tickerInput" class="form-label">Ticker Symbol</label>
                    <input type="text" class="form-control" id="tickerInput" placeholder="Enter ticker (e.g., AAPL)" required>
                </div>
                <button type="submit" class="btn btn-primary">Calculate ATR</button>
            </form>
            <div id="atrResult" class="mt-3" role="alert" style="display: none;"></div>
                </div>
        </div>
    </div>

        <!-- EDGAR Parser Tab Pane -->
        <div class="tab-pane fade utility-section" id="edgar-tab-pane" role="tabpanel" aria-labelledby="edgar-tab" tabindex="0">
            <div class="card">
        <div class="card-header">
            <h2>EDGAR Company Data Browser</h2>
        </div>
        <div class="card-body">
            <form id="edgarDataForm">
                <div class="row align-items-end">
                    <div class="col-md-9 mb-3">
                        <label for="edgarTickerInput" class="form-label">Ticker Symbol</label>
                        <input type="text" class="form-control" id="edgarTickerInput" placeholder="Enter ticker (e.g., AAPL)" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button type="submit" class="btn btn-primary w-100">Search EDGAR</button>
                    </div>
                </div>
            </form>

            <div id="edgarStatusDiv" class="mt-3" role="alert" style="display: none;"></div>
            <div id="edgarResultsDiv" class="mt-3" style="display: none;">
                <h4>Company Information (from Ticker Search)</h4>
                <pre><code id="edgarJsonOutput" class="json"></code></pre>
            </div>
                    
                    <div id="edgarConceptListContainer" class="mt-4" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4><span id="edgarConceptListHeaderSpan">Available Data Concepts</span></h4>
                            <div class="d-flex align-items-center">
                                <div class="form-check form-switch me-3">
                                    <input class="form-check-input" type="checkbox" role="switch" id="edgarShowDeprecatedToggle">
                                    <label class="form-check-label" for="edgarShowDeprecatedToggle" style="font-size: 0.8rem; white-space: nowrap;">Show Deprecated</label>
                                </div>
                                <input type="text" id="edgarConceptSearchInput" class="form-control form-control-sm ms-3" placeholder="Search concepts..." style="max-width: 200px;">
                                <button id="clearEdgarConceptSelectionsBtn" class="btn btn-sm btn-outline-secondary ms-2" type="button" title="Clear all concept selections">Clear</button>
                            </div>
                        </div>
                        <p><small>Select one or more concepts for the table view, or click a concept label to view its raw JSON.</small></p> 
                        <ul id="edgarConceptList" class="list-group mt-2" style="max-height: 400px; overflow-y: auto;">
                            <!-- Concepts will be dynamically inserted here -->
                        </ul>
                    </div>

                    <!-- Fiscal Year Input and New Fetch Button -->
                    <div id="edgarMultiFetchControls" class="mt-3" style="display: none;"> 
                        <div class="row align-items-end">
                            <div class="col-md-8 mb-3"> 
                                <label for="edgarFyInput" class="form-label">Fiscal Year(s)</label>
                                <input type="text" class="form-control" id="edgarFyInput" placeholder="Enter fiscal years e.g. 2023,2024 or 2023-2025. Leave empty for current year">
                            </div>
                            <div class="col-md-4 mb-3">
                                <button id="fetchSelectedEdgarDataBtn" class="btn btn-info w-100">Retrieve Dataset</button>
                            </div>
                        </div>
                    </div>
                    <!-- <button id="exportEdgarCustomTableBtn" class="btn btn-sm btn-success mt-2 mb-2" style="display: none;">Export Table to XLS</button> -->


                    <!-- Sub-tabs for EDGAR results -->
                    <ul class="nav nav-tabs mb-3 mt-3" id="edgarOutputSubTabs" role="tablist" style="display: none;">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tabular-view-tab" data-bs-toggle="tab" data-bs-target="#tabular-view-pane" type="button" role="tab" aria-controls="tabular-view-pane" aria-selected="true">Tabular Data</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="raw-json-view-tab" data-bs-toggle="tab" data-bs-target="#raw-json-view-pane" type="button" role="tab" aria-controls="raw-json-view-pane" aria-selected="false">Raw JSON</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="edgarOutputSubTabContent">
                        <div class="tab-pane fade show active" id="tabular-view-pane" role="tabpanel" aria-labelledby="tabular-view-tab" tabindex="0">
                            <!-- Container for custom dropdown filters -->
                            <div id="edgarTableFilters" class="row g-3 mb-3 align-items-end" style="display: none;">
                                <!-- Select filters will be dynamically added here by JS -->
                            </div>
                             <!-- <button id="exportEdgarCustomTableBtn" class="btn btn-sm btn-success mt-2 mb-2" style="display: none;">Export Table to XLS</button> -->

                            <!-- Container for the new custom table -->
                            <div id="edgarCustomTableContainer" class="mt-4" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5>Selected Concept Data (Table)</h5>
                                    <div class="d-flex align-items-center">
                                        <div class="form-check form-switch me-3">
                                            <input class="form-check-input" type="checkbox" role="switch" id="edgarCleanupToggle" checked>
                                            <label class="form-check-label" for="edgarCleanupToggle" style="white-space: nowrap;">Clean-Up Records</label>
                                            <small class="form-text text-muted d-block">Filters duplicates &amp; cumulative.</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch" id="edgar10qFillerToggle">
                                            <label class="form-check-label" for="edgar10qFillerToggle" style="white-space: nowrap;">Series Fill</label>
                                            <small class="form-text text-muted d-block">Infer Q data from FY</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered table-hover" id="edgarCustomDataTable">
                                        <thead>
                                            <!-- Headers will be dynamically inserted here by JS -->
                                        </thead>
                                        <tbody>
                                            <!-- Data rows will be dynamically inserted here by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="raw-json-view-pane" role="tabpanel" aria-labelledby="raw-json-view-tab" tabindex="0">
                            <!-- Old single concept JSON display -->
                            <div id="edgarConceptDataContainer" class="mt-4" style="display: none;"> <!-- Initially hidden, shown by JS -->
                                <h5>Concept Data (Raw JSON)</h5>
                                <pre id="edgarConceptJsonOutputCodeBlock" style="max-height: 400px; overflow-y: auto;"><code id="edgarConceptJsonOutput" class="json"></code></pre>
                            </div>
                        </div>
                    </div>

                    <div id="edgarFactsTableContainer" class="mt-4" style="display: none;"> <!-- Original full facts table, remains hidden -->
                <h4>Company Facts</h4>
                <button id="exportEdgarFactsBtn" class="btn btn-sm btn-success mb-2" style="display: none;">Export to XLS</button>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover" id="edgarFactsTable">
                        <thead>
                            <!-- Headers will be dynamically inserted here -->
                        </thead>
                        <tbody>
                            <!-- Data rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
        </div>

        <!-- Data LCM Tab Pane -->
        <div class="tab-pane fade utility-section" id="datalcm-tab-pane" role="tabpanel" aria-labelledby="datalcm-tab" tabindex="0">
            <!-- Nav tabs for Data LCM -->
            <ul class="nav nav-pills mb-3" id="dataLcmSubTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="db-status-subtab" data-bs-toggle="tab" data-bs-target="#db-status-subtab-pane" type="button" role="tab" aria-controls="db-status-subtab-pane" aria-selected="true">DB Status</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="db-cleanup-subtab" data-bs-toggle="tab" data-bs-target="#db-cleanup-subtab-pane" type="button" role="tab" aria-controls="db-cleanup-subtab-pane" aria-selected="false">DB Clean-Up</button>
                </li>
            </ul>

            <!-- Tab panes for Data LCM -->
            <div class="tab-content" id="dataLcmSubTabContent">
                <!-- DB Status Sub-Tab Pane -->
                <div class="tab-pane fade show active" id="db-status-subtab-pane" role="tabpanel" aria-labelledby="db-status-subtab" tabindex="0">
                    <div class="card">
                        <div class="card-header">
                            <h2>Database Status</h2>
                        </div>
                        <div class="card-body">
                            <div id="dbStatusContainer">
                                <p><strong>Database Size:</strong> <span id="dbSizeValue">Loading...</span></p>
                                <p><strong>Yahoo Master Records:</strong> <span id="yahooMasterCountValue">Loading...</span></p>
                                <p><strong>Yahoo Items Records:</strong> <span id="yahooItemsCountValue">Loading...</span></p>
                                <p><strong>Analytics Raw Records:</strong> <span id="analyticsRawCountValue">Loading...</span></p>
                            </div>
                            <button id="refreshDbStatusBtn" class="btn btn-primary mt-3">Refresh Status</button>
                            <div id="dbStatusMessage" class="mt-2" role="alert"></div>
                        </div>
                    </div>
                </div>
                <!-- DB Clean-Up Sub-Tab Pane -->
                <div class="tab-pane fade" id="db-cleanup-subtab-pane" role="tabpanel" aria-labelledby="db-cleanup-subtab" tabindex="0">
                    <div class="card">
                        <div class="card-header">
                            <h2>Database Cleanup</h2>
                        </div>
                        <div class="card-body">
                            <p>Scan the database for records that are largely incomplete and remove them to maintain data quality.</p>
                            
                            <!-- Filter Controls -->
                            <div class="row g-3 align-items-center mb-3 p-3 border rounded bg-body-tertiary">
                                <div class="col-md-5">
                                    <label for="emptinessThresholdSlider" class="form-label">Min. Emptiness Threshold: <span id="emptinessThresholdValue" class="fw-bold">70%</span></label>
                                    <input type="range" class="form-range" min="0" max="100" step="1" id="emptinessThresholdSlider" value="70">
                                </div>
                                <div class="col-md-3">
                                    <label for="startDateFilter" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="startDateFilter">
                                </div>
                                <div class="col-md-3">
                                    <label for="endDateFilter" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="endDateFilter">
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button id="clearDateFiltersBtn" class="btn btn-outline-secondary btn-sm" title="Clear date filters">Clear</button>
                                </div>
                            </div>
                            
                            <button id="scanInvalidRecordsBtn" class="btn btn-warning">Scan for Invalid Records</button>
                            <div id="cleanupSpinner" class="spinner-border text-warning ms-2" role="status" style="display: none;">
                                <span class="visually-hidden">Loading...</span>
                            </div>

                            <div id="cleanupResultsContainer" class="mt-4" style="display: none;">
                                <h4>Scan Results</h4>
                                <p id="cleanupSummaryText"></p>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <button id="deleteSelectedRecordsBtn" class="btn btn-danger" disabled>Delete Selected</button>
                                        <button id="selectAllForCleanupBtn" class="btn btn-outline-secondary btn-sm ms-2">Select All</button>
                                    </div>
                                </div>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-bordered table-hover" id="invalidRecordsTable">
                                        <thead>
                                            <tr>
                                                <th style="width: 5%;"><input type="checkbox" id="selectAllCleanupCheckbox" title="Select/Deselect all"></th>
                                                <th style="width: 15%;">Table</th>
                                                <th style="width: 15%;">Primary Key</th>
                                                <th style="width: 15%;">Ticker</th>
                                                <th style="width: 15%;">Date</th>
                                                <th>Reason for Flagging</th>
                                            </tr>
                                        </thead>
                                        <tbody id="invalidRecordsTbody">
                                            <!-- Rows will be inserted here by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="cleanupStatusMessage" class="mt-3" role="alert" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LLM Analytics Tab Pane -->
        <div class="tab-pane fade utility-section" id="llm-analytics-tab-pane" role="tabpanel" aria-labelledby="llm-analytics-tab" tabindex="0">
            <div class="card">
                <div class="card-header">
                    <h2>AI Report Assistant</h2>
                </div>
                <div class="card-body">
                    <p class="card-text">Enter tickers, write a prompt, and get instant financial analysis powered by Google's Gemini LLM.</p>
            
                    <!-- Ticker Selection Display -->
                    <div id="llmSelectedTickersContainer" class="mb-3" style="display: none;">
                        <strong>Selected Tickers:</strong>
                        <div id="llmSelectedTickers" class="d-flex flex-wrap gap-2 mt-2">
                            <!-- Ticker badges will be here -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <button id="llmOpenModalBtn" class="btn btn-outline-secondary">Select Tickers</button>
                    </div>

                    <div class="mb-3">
                        <label for="llmPrompt" class="form-label">Your Prompt</label>
                        <textarea class="form-control" id="llmPrompt" rows="5" placeholder="e.g., 'Compare the revenue growth and profitability of these companies over the last year.'">prepare a detailed financial report comparing all key metrics for the defined tickers. the report should have three distinct sections: (a) financial assessment based on company fundamentals (b) technical assessment based on stock performance (c) sentiment assessment based on available forecasts and analyst opinions. when there are more than one tickers submitted add an additional section d) comparative analysis of the provided tickers. Base your analysis entirely on the attached data. For every calculation and assessment, always clearly reference the data point(s) you use and what is the source document of this datapoint. the report should conclude with an apraisal of the overal appeal of each stock (pros/cons) and a recommendation in the scale of 1-strong buy, 2-buy, 3-hold, 4-sell , 5-strong sell.</textarea>
                    </div>
                    <button id="llmGenerateBtn" class="btn btn-primary">Generate Report</button>
                    <button id="llmStartOverBtn" class="btn btn-secondary" style="display: none;">Start Over</button>
                </div>
            </div>

            <!-- Report Output Section -->
            <div id="llmReportCard" class="card mt-4" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Generated Report</h5>
                    <span id="llmModelInfo" class="badge bg-secondary"></span>
                </div>
                <div class="card-body">
                    <div id="llmReportOutput">
                        <!-- Chat messages will appear here -->
                    </div>
                    <!-- Spinner now lives here, at the bottom of the chat/report body -->
                    <div id="llmSpinner" class="d-flex align-items-center mt-3 d-none">
                        <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                        <strong>AI is thinking...</strong>
                    </div>
                    <!-- Follow-up input area -->
                    <div id="llmFollowUpContainer" class="mt-3" style="display: none;">
                      <hr>
                      <div class="input-group">
                        <textarea id="llmFollowUpPrompt" class="form-control" placeholder="Ask a follow-up question..." rows="2"></textarea>
                        <button id="llmFollowUpBtn" class="btn btn-primary">Send</button>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EDGAR Chart Modal -->
<div class="modal fade" id="edgarChartModal" tabindex="-1" aria-labelledby="edgarChartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="edgarChartModalLabel">EDGAR Data Chart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div style="position: relative; height: 60vh;">
            <canvas id="edgarBarChartCanvas"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LLM Ticker Selection Modal -->
<div class="modal fade" id="llmTickerModal" tabindex="-1" aria-labelledby="llmTickerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="llmTickerModalLabel">Select Tickers</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="llmTickerSearchInput" placeholder="Search for tickers...">
          <button class="btn btn-outline-secondary" type="button" id="llmClearSelectedBtn">Clear</button>
        </div>
        <div class="list-group" id="llmTickerList" style="max-height: 300px; overflow-y: auto;">
          <!-- Ticker list will be dynamically inserted here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="llmAddSelectedTickersBtn">Add Selected</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }} {# Include scripts from base.html if any #}
<script src="{{ url_for('static', path='js/edgar_utils.js') }}"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- ATR Calculator Logic --- 
    const atrForm = document.getElementById('atrCalculatorForm');
    const tickerInput = document.getElementById('tickerInput');
    const atrResultDiv = document.getElementById('atrResult');

    if (atrForm) { // Add null check for atrForm
        atrForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const ticker = tickerInput.value.trim().toUpperCase();
            if (!ticker) {
                displayResult('Ticker symbol cannot be empty.', 'error');
                return;
            }

            if (atrResultDiv) { // Check if atrResultDiv exists before manipulating
                atrResultDiv.style.display = 'block';
                atrResultDiv.className = ''; // Reset classes
                atrResultDiv.textContent = 'Calculating...';
            }

            try {
                const response = await fetch('/api/v3/utilities/calculate_atr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ticker: ticker, period: 14 })
                });

                if (!response.ok) {
                    let errorMsg = `Error: ${response.status} ${response.statusText}`;
                    try {
                        const errData = await response.json();
                        errorMsg = errData.detail || errData.error || errorMsg;
                    } catch (e) {
                        // If error response is not JSON, use the initial errorMsg
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();

                if (data.atr_value !== null && data.atr_value !== undefined) {
                    displayResult(`ATR (14) for ${data.ticker}: ${parseFloat(data.atr_value).toFixed(4)}`, 'success');
                } else if (data.error) {
                    displayResult(`Error: ${data.error}`, 'error');
                } else {
                    displayResult('Unexpected response from server.', 'error');
                }

            } catch (error) {
                console.error('ATR Calculation Error:', error);
                displayResult(error.message || 'Failed to calculate ATR. Check console for details.', 'error');
            }
        });
    }

    function displayResult(message, type) {
        if (atrResultDiv) { // Add null check
            atrResultDiv.textContent = message;
            atrResultDiv.className = type; // 'success' or 'error'
            atrResultDiv.style.display = 'block';
        }
    }

    // Note: EDGAR specific logic is now in edgar_utils.js and should still work as IDs are preserved.

    // --- Theme Toggle Logic --- 
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            document.cookie = `theme_preference=${newTheme};path=/;max-age=${30*24*60*60}`; // Expires in 30 days
        });
    }

    (function() {
        const preferredTheme = document.cookie.split('; ').find(row => row.startsWith('theme_preference='))?.split('=')[1];
        if (preferredTheme) {
            document.documentElement.setAttribute('data-bs-theme', preferredTheme);
        }
    })();

    // XLS Export function is in edgar_utils.js, if needed by EDGAR parser.

    // --- Data LCM - Database Status Logic ---
    const refreshDbStatusBtn = document.getElementById('refreshDbStatusBtn');
    const dbSizeValueSpan = document.getElementById('dbSizeValue');
    const yahooMasterCountValueSpan = document.getElementById('yahooMasterCountValue');
    const yahooItemsCountValueSpan = document.getElementById('yahooItemsCountValue');
    const analyticsRawCountValueSpan = document.getElementById('analyticsRawCountValue');
    const dbStatusMessageDiv = document.getElementById('dbStatusMessage');
    const dataLcmTabPane = document.getElementById('datalcm-tab-pane');

    async function fetchAndDisplayDbStatus() {
        if (!dbSizeValueSpan || !yahooMasterCountValueSpan || !yahooItemsCountValueSpan || !analyticsRawCountValueSpan || !dbStatusMessageDiv) {
            console.warn('One or more DB status elements not found in the DOM.');
            return;
        }

        dbStatusMessageDiv.textContent = 'Loading status...';
        dbStatusMessageDiv.className = 'alert alert-info';
        dbSizeValueSpan.textContent = 'Loading...';
        yahooMasterCountValueSpan.textContent = 'Loading...';
        yahooItemsCountValueSpan.textContent = 'Loading...';
        analyticsRawCountValueSpan.textContent = 'Loading...';

        try {
            const response = await fetch('/api/v3/database/status');
            if (!response.ok) {
                let errorMsg = `Error: ${response.status} ${response.statusText}`;
                try {
                    const errData = await response.json();
                    errorMsg = errData.detail || errData.error || errorMsg;
                } catch (e) { /* Ignore if error response is not JSON */ }
                throw new Error(errorMsg);
            }
            const data = await response.json();

            dbSizeValueSpan.textContent = data.db_size !== null ? data.db_size : 'N/A';
            yahooMasterCountValueSpan.textContent = data.yahoo_master_count !== null ? data.yahoo_master_count.toLocaleString() : 'N/A';
            yahooItemsCountValueSpan.textContent = data.yahoo_items_count !== null ? data.yahoo_items_count.toLocaleString() : 'N/A';
            analyticsRawCountValueSpan.textContent = data.analytics_raw_count !== null ? data.analytics_raw_count.toLocaleString() : 'N/A';
            
            dbStatusMessageDiv.textContent = 'Status loaded successfully.';
            dbStatusMessageDiv.className = 'alert alert-success';
        } catch (error) {
            console.error('Error fetching DB status:', error);
            dbSizeValueSpan.textContent = 'Error';
            yahooMasterCountValueSpan.textContent = 'Error';
            yahooItemsCountValueSpan.textContent = 'Error';
            analyticsRawCountValueSpan.textContent = 'Error';
            dbStatusMessageDiv.textContent = `Failed to load status: ${error.message}`;
            dbStatusMessageDiv.className = 'alert alert-danger';
        }
    }

    if (refreshDbStatusBtn) {
        refreshDbStatusBtn.addEventListener('click', fetchAndDisplayDbStatus);
    }

    // Automatically load status if the Data LCM tab is active or becomes active.
    // This uses a MutationObserver to detect when the tab becomes visible.
    // More robust would be to listen to Bootstrap's tab shown event if available/easy.
    if (dataLcmTabPane) {
        const observer = new MutationObserver((mutationsList, obs) => {
            for(const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (dataLcmTabPane.classList.contains('active') && dataLcmTabPane.classList.contains('show')) {
                        // Tab became active, load data if not already loaded (or re-load)
                        // To prevent multiple loads if already loading, add a flag or check content of spans.
                        if (dbSizeValueSpan && dbSizeValueSpan.textContent === 'Loading...') {
                             fetchAndDisplayDbStatus();
                        }
                    }
                }
            }
        });
        observer.observe(dataLcmTabPane, { attributes: true });

        // Initial load if the tab is already active on page load
        if (dataLcmTabPane.classList.contains('active') && dataLcmTabPane.classList.contains('show')) {
            fetchAndDisplayDbStatus();
        }
    }

    // --- Database Cleanup Logic ---
    const scanBtn = document.getElementById('scanInvalidRecordsBtn');
    const cleanupSpinner = document.getElementById('cleanupSpinner');
    const resultsContainer = document.getElementById('cleanupResultsContainer');
    const summaryText = document.getElementById('cleanupSummaryText');
    const recordsTbody = document.getElementById('invalidRecordsTbody');
    const statusMessage = document.getElementById('cleanupStatusMessage');
    const deleteBtn = document.getElementById('deleteSelectedRecordsBtn');
    const selectAllCheckbox = document.getElementById('selectAllCleanupCheckbox');
    const selectAllBtn = document.getElementById('selectAllForCleanupBtn');
    const emptinessThresholdSlider = document.getElementById('emptinessThresholdSlider');
    const emptinessThresholdValue = document.getElementById('emptinessThresholdValue');
    const startDateFilter = document.getElementById('startDateFilter');
    const endDateFilter = document.getElementById('endDateFilter');
    const clearDateFiltersBtn = document.getElementById('clearDateFiltersBtn');
    let cleanupDataTable = null;

    if(emptinessThresholdSlider && emptinessThresholdValue) {
        emptinessThresholdSlider.addEventListener('input', (event) => {
            emptinessThresholdValue.textContent = `${event.target.value}%`;
        });
    }

    if(clearDateFiltersBtn) {
        clearDateFiltersBtn.addEventListener('click', () => {
            startDateFilter.value = '';
            endDateFilter.value = '';
        });
    }

    if (scanBtn) {
        scanBtn.addEventListener('click', async () => {
            // Reset UI
            scanBtn.disabled = true;
            cleanupSpinner.style.display = 'inline-block';
            resultsContainer.style.display = 'none';
            statusMessage.style.display = 'none';
            
            // Destroy existing DataTable instance if it exists
            if (cleanupDataTable) {
                cleanupDataTable.destroy();
                cleanupDataTable = null;
            }
            recordsTbody.innerHTML = '';
            deleteBtn.disabled = true;

            const filters = {
                threshold: parseInt(emptinessThresholdSlider.value, 10) / 100.0,
                start_date: startDateFilter.value || null,
                end_date: endDateFilter.value || null
            };

            try {
                const response = await fetch('/api/v3/utilities/scan-invalid-records', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'Failed to scan for records.');
                }
                const data = await response.json();

                let totalInvalid = 0;
                const master_records = data.ticker_master || [];
                const item_records = data.ticker_data_items || [];

                master_records.forEach(rec => {
                    if (rec.primary_key) {
                        addRecordToTable('ticker_master', rec.primary_key, rec.reason, rec.primary_key); // For master table, ticker is the PK
                        totalInvalid++;
                    }
                });
                item_records.forEach(rec => {
                    if (rec.primary_key) {
                        addRecordToTable('ticker_data_items', rec.primary_key, rec.reason, rec.ticker, rec.item_key_date);
                        totalInvalid++;
                    }
                });

                summaryText.textContent = `Found ${totalInvalid} potentially invalid records.`;
                resultsContainer.style.display = 'block';

                const actionButtonsContainer = resultsContainer.querySelector('.d-flex');
                if (totalInvalid === 0) {
                    if(actionButtonsContainer) actionButtonsContainer.style.display = 'none';
                } else {
                    if(actionButtonsContainer) actionButtonsContainer.style.display = 'flex';
                    // Initialize DataTable
                    cleanupDataTable = new DataTable('#invalidRecordsTable', {
                        paging: false,
                        info: false,
                        searching: false,
                        columnDefs: [
                            { orderable: false, targets: 0 } // Disable sorting on the checkbox column
                        ],
                        order: [[4, 'desc']] // Default sort by Date descending
                    });
                }

            } catch (error) {
                showCleanupStatus(error.message, 'danger');
            } finally {
                scanBtn.disabled = false;
                cleanupSpinner.style.display = 'none';
            }
        });
    }

    function addRecordToTable(table, pk, reason, ticker = null, date = null) {
        const row = document.createElement('tr');
        // Use an unambiguous date format for display and sorting
        const formattedDate = date ? new Date(date).toISOString().split('T')[0] : 'N/A';
        const displayTicker = ticker || 'N/A';

        row.innerHTML = `
            <td><input type="checkbox" class="cleanup-checkbox form-check-input" data-table="${table}" data-pk="${pk}"></td>
            <td>${table}</td>
            <td>${pk}</td>
            <td>${displayTicker}</td>
            <td>${formattedDate}</td>
            <td><small>${reason}</small></td>
        `;
        recordsTbody.appendChild(row);
    }

    function showCleanupStatus(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.className = `alert alert-${type}`;
        statusMessage.style.display = 'block';
    }

    if (recordsTbody) {
        recordsTbody.addEventListener('change', (event) => {
            if (event.target.classList.contains('cleanup-checkbox')) {
                const anyChecked = recordsTbody.querySelector('.cleanup-checkbox:checked');
                deleteBtn.disabled = !anyChecked;
            }
        });
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', () => {
            const checkboxes = recordsTbody.querySelectorAll('.cleanup-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            deleteBtn.disabled = !selectAllCheckbox.checked && checkboxes.length > 0;
        });
    }

    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', () => {
            selectAllCheckbox.checked = true;
            const checkboxes = recordsTbody.querySelectorAll('.cleanup-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            deleteBtn.disabled = !(checkboxes.length > 0);
        });
    }

    if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
            const selectedCheckboxes = recordsTbody.querySelectorAll('.cleanup-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedCheckboxes.length} records? This action cannot be undone.`)) {
                return;
            }

            const recordsToDelete = {
                ticker_master: [],
                ticker_data_items: []
            };

            selectedCheckboxes.forEach(cb => {
                const table = cb.dataset.table;
                const pk = cb.dataset.pk;
                if (table === 'ticker_master') {
                    recordsToDelete.ticker_master.push(pk);
                } else if (table === 'ticker_data_items') {
                    recordsToDelete.ticker_data_items.push(parseInt(pk, 10));
                }
            });

            deleteBtn.disabled = true;
            scanBtn.disabled = true;
            cleanupSpinner.style.display = 'inline-block';
            statusMessage.style.display = 'none';
            let deletionSucceeded = false;

            try {
                const response = await fetch('/api/v3/utilities/delete-invalid-records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recordsToDelete)
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'Failed to delete records.');
                }

                const summary = await response.json();
                const totalDeleted = summary.deleted_master_count + summary.deleted_items_count;
                const totalErrors = summary.errors ? summary.errors.length : 0;
                let message = `Successfully deleted ${totalDeleted} records.`;
                if (totalErrors > 0) {
                    message += ` Failed to delete ${totalErrors} records. Check console for details.`;
                    console.error("Deletion errors:", summary.errors);
                }

                showCleanupStatus(message, totalErrors > 0 ? 'warning' : 'success');
                deletionSucceeded = true;

            } catch (error) {
                showCleanupStatus(error.message, 'danger');
            } finally {
                cleanupSpinner.style.display = 'none';
                scanBtn.disabled = false; // Always re-enable scan button
                if (deletionSucceeded) {
                    scanBtn.click(); // Re-scan to show updated list
                } else {
                    // On failure, re-enable delete button if there's still a selection
                    const anyChecked = recordsTbody.querySelector('.cleanup-checkbox:checked');
                    deleteBtn.disabled = !anyChecked;
                }
            }
        });
    }

    // Self-contained logic for the LLM Analytics Tab
    const llmTabPane = document.getElementById('llm-analytics-tab-pane');
    if (!llmTabPane) {
        // If the LLM pane isn't here, do nothing.
        return;
    }

    // Get all required elements
    const llmPrompt = document.getElementById('llmPrompt');
    const llmGenerateBtn = document.getElementById('llmGenerateBtn');
    const llmSpinner = document.getElementById('llmSpinner');
    const llmReportCard = document.getElementById('llmReportCard');
    const llmReportOutput = document.getElementById('llmReportOutput');
    const llmSelectedTickersDiv = document.getElementById('llmSelectedTickers');
    const llmSelectedTickersContainer = document.getElementById('llmSelectedTickersContainer');
    const llmOpenModalBtn = document.getElementById('llmOpenModalBtn');
    const llmTickerModal = document.getElementById('llmTickerModal');
    const llmTickerSearchInput = document.getElementById('llmTickerSearchInput');
    const llmTickerList = document.getElementById('llmTickerList');
    const llmClearSelectedBtn = document.getElementById('llmClearSelectedBtn');
    const llmAddSelectedTickersBtn = document.getElementById('llmAddSelectedTickersBtn');
    const llmFollowUpContainer = document.getElementById('llmFollowUpContainer');
    const llmFollowUpPrompt = document.getElementById('llmFollowUpPrompt');
    const llmFollowUpBtn = document.getElementById('llmFollowUpBtn');
    const llmStartOverBtn = document.getElementById('llmStartOverBtn');

    // State variables
    let allTickers = [];
    let selectedTickers = new Set();
    let llmConversationHistory = [];

    // --- Ticker Loading and Caching ---
    async function loadTickers() {
        const cacheKey = 'dbTickersList';
        sessionStorage.removeItem(cacheKey); // --- ADDED FOR DEBUGGING ---
        const cachedData = sessionStorage.getItem(cacheKey);

        if (cachedData) {
            try {
                allTickers = JSON.parse(cachedData);
                enableSearch();
                return;
            } catch (e) {
                console.error("Failed to parse cached tickers, refetching.", e);
                sessionStorage.removeItem(cacheKey);
            }
        }

        try {
            const response = await fetch('/api/v3/utilities/all-tickers-with-names');
            if (!response.ok) {
                throw new Error(`Failed to load tickers list: ${response.statusText}`);
            }
            allTickers = await response.json();
            // --- ADDED FOR DEBUGGING ---
            console.log("Fetched tickers data from API:", allTickers);
            console.log(`Found ${allTickers.length} total tickers.`);
            // --- END DEBUGGING ---
            sessionStorage.setItem(cacheKey, JSON.stringify(allTickers));
            enableSearch();
        } catch (error) {
            console.error(error);
            alert("Error loading tickers. Please refresh.");
        }
    }

    function enableSearch() {
        llmTickerSearchInput.disabled = false;
        llmTickerSearchInput.placeholder = "Search by Ticker or Company Name...";
    }

    // --- UI Interaction Logic ---
    llmTickerSearchInput.addEventListener('input', () => {
        const query = llmTickerSearchInput.value.toLowerCase().trim();
        llmTickerList.innerHTML = '';
        if (query.length === 0) {
            return;
        }

        // Filter based on both ticker and name. Handles cases where name might be empty.
        const filtered = allTickers
            .filter(item =>
                ((item.ticker && item.ticker.toLowerCase().startsWith(query)) || (item.name && item.name.toLowerCase().includes(query)))
                && !selectedTickers.has(item.ticker)
            )
            .slice(0, 7); // Show a max of 7 suggestions

        if (filtered.length > 0) {
            filtered.forEach(item => {
                const a = document.createElement('a');
                a.href = '#';
                a.className = 'list-group-item list-group-item-action';
                // Display both ticker and name for clarity
                a.textContent = item.name ? `${item.ticker} - ${item.name}` : item.ticker;
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    addTickerToSelection(item.ticker);
                });
                llmTickerList.appendChild(a);
            });
        }
    });

    llmClearSelectedBtn.addEventListener('click', () => {
        llmTickerSearchInput.value = '';
        llmTickerList.innerHTML = '';
    });

    llmAddSelectedTickersBtn.addEventListener('click', () => {
        const selectedOptions = Array.from(llmTickerList.querySelectorAll('.active'));
        selectedOptions.forEach(option => {
            addTickerToSelection(option.textContent);
        });
        bootstrap.Modal.getInstance(llmTickerModal).hide();
    });

    llmOpenModalBtn.addEventListener('click', () => {
        bootstrap.Modal.getOrCreateInstance(llmTickerModal).show();
    });

    function addTickerToSelection(ticker) {
        if (selectedTickers.has(ticker)) return;
        selectedTickers.add(ticker);
        updateSelectedTickersUI();
        // Clear search and hide suggestions
        llmTickerSearchInput.value = '';
        llmTickerList.innerHTML = '';
        llmTickerSearchInput.focus();
    }

    function removeTickerFromSelection(ticker) {
        selectedTickers.delete(ticker);
        updateSelectedTickersUI();
    }

    function updateSelectedTickersUI() {
        llmSelectedTickersDiv.innerHTML = '';
        selectedTickers.forEach(ticker => {
            const badge = createTickerBadge(ticker);
            llmSelectedTickersDiv.appendChild(badge);
        });

        if (selectedTickers.size > 0) {
            llmSelectedTickersContainer.style.display = 'block';
        } else {
            llmSelectedTickersContainer.style.display = 'none';
        }
    }

    function createTickerBadge(ticker) {
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary d-flex align-items-center';
        badge.style.fontSize = '0.9em';
        badge.innerHTML = `
            ${ticker}
            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.6em;" aria-label="Remove"></button>
        `;
        const removeBtn = badge.querySelector('button');
        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent the badge click from firing
            removeTickerFromSelection(ticker);
        });
        return badge;
    }

    // --- Initializer ---
    loadTickers();

    // --- Reset and Start Over ---
    function resetLlmUI() {
        llmConversationHistory = [];
        
        llmReportOutput.innerHTML = '';
        llmReportCard.style.display = 'none';
        llmFollowUpContainer.style.display = 'none';
        
        llmGenerateBtn.disabled = false;
        llmGenerateBtn.style.display = 'inline-block';
        llmOpenModalBtn.disabled = false;

        llmStartOverBtn.style.display = 'none';
    }

    llmStartOverBtn.addEventListener('click', resetLlmUI);


    // --- API Call Logic ---
    llmGenerateBtn.addEventListener('click', async () => {
        const prompt = llmPrompt.value.trim();
        const tickers = Array.from(selectedTickers);

        if (tickers.length === 0) {
            alert('Please select at least one ticker.');
            return;
        }
        if (!prompt) {
            alert('Please enter a prompt.');
            return;
        }

        // Reset UI for new report
        llmReportCard.style.display = 'block';
        llmReportOutput.innerHTML = '';
        llmSpinner.classList.remove('d-none');
        llmGenerateBtn.disabled = true;
        llmOpenModalBtn.disabled = true;
        llmFollowUpContainer.style.display = 'none';

        try {
            const response = await fetch('/api/v3/utilities/generate_llm_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tickers, prompt })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            llmConversationHistory = data.history || [];
            
            // Display the model name
            const modelInfoSpan = document.getElementById('llmModelInfo');
            if (modelInfoSpan && data.model_name) {
                modelInfoSpan.textContent = `Model: ${data.model_name}`;
            }

            // Render initial report in a styled message bubble
            appendChatMessage(data.report_markdown, 'model-message');
            
            // Show/hide buttons for conversation mode
            llmFollowUpContainer.style.display = 'block';
            llmStartOverBtn.style.display = 'inline-block';
            llmGenerateBtn.style.display = 'none';


        } catch (error) {
            console.error('Error generating report:', error);
            appendChatMessage(`Error: ${error.message}`, 'model-message', true);
        } finally {
            llmSpinner.classList.add('d-none');
            // llmGenerateBtn is re-enabled via Start Over button
        }
    });

    llmFollowUpBtn.addEventListener('click', async () => {
        const prompt = llmFollowUpPrompt.value.trim();
        if (!prompt) {
            return;
        }

        appendChatMessage(prompt, 'user-message');
        llmConversationHistory.push({ role: 'user', parts: [{ text: prompt }] });
        llmFollowUpPrompt.value = '';
        llmSpinner.classList.remove('d-none');
        llmFollowUpBtn.disabled = true;

        try {
            const response = await fetch('/api/v3/utilities/llm_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ history: llmConversationHistory })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            llmConversationHistory.push({ role: 'model', parts: [{ text: data.response_markdown }] });
            appendChatMessage(data.response_markdown, 'model-message');

        } catch (error) {
            console.error('Error in follow-up chat:', error);
            appendChatMessage(`Error: ${error.message}`, 'model-message', true);
        } finally {
            llmSpinner.classList.add('d-none');
            llmFollowUpBtn.disabled = false;
        }
    });

    function appendChatMessage(markdown, role, isError = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `llm-chat-message ${role}`;

        if (isError) {
            messageDiv.classList.add('alert', 'alert-danger');
            messageDiv.textContent = markdown;
        } else {
            messageDiv.innerHTML = marked.parse(markdown);
        }
        
        llmReportOutput.appendChild(messageDiv);
        llmReportOutput.scrollTop = llmReportOutput.scrollHeight; // Auto-scroll to bottom
    }
});
</script>
{% endblock %}
