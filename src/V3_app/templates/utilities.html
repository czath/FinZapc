{% extends "base.html" %}

{% block title %}Utilities - {{ super() }}{% endblock %}

{% block head_extra %}
<style>
  .utility-section {
    padding: 20px;
    margin-bottom: 30px;
    border-radius: 8px;
    background-color: var(--bs-card-bg); /* Use theme card background */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Subtle shadow */
  }
  .utility-section h2 {
    margin-bottom: 20px;
    color: var(--bs-heading-color);
  }
  #atrResult {
    margin-top: 15px;
    padding: 10px;
    border-radius: 4px;
    /* background-color: var(--bs-tertiary-bg); /* Light background for result */
    /* border: 1px solid var(--bs-border-color); */
  }
  #atrResult.success {
    background-color: var(--bs-success-bg-subtle, #d1e7dd); /* Bootstrap 5.3 success bg subtle */
    border-color: var(--bs-success-border-subtle, #badbcc);
    color: var(--bs-success-text-emphasis, #0a3622);
  }
  #atrResult.error {
    background-color: var(--bs-danger-bg-subtle, #f8d7da); /* Bootstrap 5.3 danger bg subtle */
    border-color: var(--bs-danger-border-subtle, #f5c2c7);
    color: var(--bs-danger-text-emphasis, #58151c);
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Utilities</h1>

    <div class="utility-section card">
        <div class="card-header">
            <h2>ATR Calculator</h2>
        </div>
        <div class="card-body">
            <form id="atrCalculatorForm">
                <div class="mb-3">
                    <label for="tickerInput" class="form-label">Ticker Symbol</label>
                    <input type="text" class="form-control" id="tickerInput" placeholder="Enter ticker (e.g., AAPL)" required>
                </div>
                <button type="submit" class="btn btn-primary">Calculate ATR</button>
            </form>
            <div id="atrResult" class="mt-3" role="alert" style="display: none;"></div>
        </div>
    </div>

    <!-- More utilities can be added here in separate utility-section divs -->

    <div class="utility-section card mt-4">
        <div class="card-header">
            <h2>EDGAR Company Data Fetcher</h2>
        </div>
        <div class="card-body">
            <form id="edgarDataForm">
                <div class="mb-3">
                    <label for="edgarTickerInput" class="form-label">Ticker Symbol</label>
                    <input type="text" class="form-control" id="edgarTickerInput" placeholder="Enter ticker (e.g., AAPL)" required>
                </div>
                <button type="submit" class="btn btn-primary">Fetch EDGAR Data</button>
            </form>
            <div id="edgarStatusDiv" class="mt-3" role="alert" style="display: none;"></div>
            <div id="edgarResultsDiv" class="mt-3" style="display: none;">
                <h4>Company Information (from Ticker Search)</h4>
                <pre><code id="edgarJsonOutput" class="json"></code></pre>
            </div>
            <div id="edgarFactsTableContainer" class="mt-4" style="display: none;">
                <h4>Company Facts</h4>
                <button id="exportEdgarFactsBtn" class="btn btn-sm btn-success mb-2" style="display: none;">Export to XLS</button>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover" id="edgarFactsTable">
                        <thead>
                            <!-- Headers will be dynamically inserted here -->
                        </thead>
                        <tbody>
                            <!-- Data rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }} {# Include scripts from base.html if any #}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- ATR Calculator Logic --- 
    const atrForm = document.getElementById('atrCalculatorForm');
    const tickerInput = document.getElementById('tickerInput');
    const atrResultDiv = document.getElementById('atrResult');

    if (atrForm) { // Add null check for atrForm
        atrForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const ticker = tickerInput.value.trim().toUpperCase();
            if (!ticker) {
                displayResult('Ticker symbol cannot be empty.', 'error');
                return;
            }

            if (atrResultDiv) { // Check if atrResultDiv exists before manipulating
                atrResultDiv.style.display = 'block';
                atrResultDiv.className = ''; // Reset classes
                atrResultDiv.textContent = 'Calculating...';
            }

            try {
                const response = await fetch('/api/utilities/calculate_atr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ticker: ticker, period: 14 })
                });

                if (!response.ok) {
                    let errorMsg = `Error: ${response.status} ${response.statusText}`;
                    try {
                        const errData = await response.json();
                        errorMsg = errData.detail || errData.error || errorMsg;
                    } catch (e) {
                        // If error response is not JSON, use the initial errorMsg
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();

                if (data.atr_value !== null && data.atr_value !== undefined) {
                    displayResult(`ATR (14) for ${data.ticker}: ${parseFloat(data.atr_value).toFixed(4)}`, 'success');
                } else if (data.error) {
                    displayResult(`Error: ${data.error}`, 'error');
                } else {
                    displayResult('Unexpected response from server.', 'error');
                }

            } catch (error) {
                console.error('ATR Calculation Error:', error);
                displayResult(error.message || 'Failed to calculate ATR. Check console for details.', 'error');
            }
        });
    }

    function displayResult(message, type) {
        if (atrResultDiv) { // Add null check
            atrResultDiv.textContent = message;
            atrResultDiv.className = type; // 'success' or 'error'
            atrResultDiv.style.display = 'block';
        }
    }

    // --- EDGAR Data Fetcher Logic --- 
    const edgarForm = document.getElementById('edgarDataForm');
    const edgarTickerInput = document.getElementById('edgarTickerInput');
    let currentEdgarExportContext = { cik: null, ticker: null }; // Added for export context

    const exportEdgarFactsBtn = document.getElementById('exportEdgarFactsBtn');
    if (exportEdgarFactsBtn) {
        exportEdgarFactsBtn.addEventListener('click', function() {
            if (currentEdgarExportContext.cik && currentEdgarExportContext.ticker) {
                const today = new Date().toISOString().slice(0, 10);
                const filename = `EDGAR_Facts_${currentEdgarExportContext.ticker}_CIK${currentEdgarExportContext.cik}_${today}.xls`;
                exportTableToXLS('edgarFactsTable', filename);
            } else {
                alert('No CIK or Ticker context available for export. Please fetch data first.');
                console.warn('Export button clicked without context:', currentEdgarExportContext);
            }
        });
    }
    
    if (edgarForm) {
        edgarForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            clearEdgarResults(); 

            const ticker = edgarTickerInput.value.trim().toUpperCase();
            const statusDiv = document.getElementById('edgarStatusDiv'); 

            if (!ticker) {
                displayEdgarError('Ticker symbol cannot be empty.');
                return;
            }

            if (statusDiv){
                statusDiv.textContent = `Fetching CIK for ${ticker}...`;
                statusDiv.className = 'alert alert-info mt-3';
                statusDiv.style.display = 'block';
            }

            try {
                const companyInfoResponse = await fetch(`/api/v3/edgar/company-tickers?ticker=${encodeURIComponent(ticker)}`);
                if (!companyInfoResponse.ok) {
                    const errorData = await companyInfoResponse.json().catch(() => ({ detail: companyInfoResponse.statusText }));
                    throw new Error(errorData.detail || `HTTP error! status: ${companyInfoResponse.status}`);
                }
                const companyInfo = await companyInfoResponse.json();
                if (!companyInfo || !companyInfo.cik_str) {
                    displayEdgarError(`CIK not found for ticker ${ticker}.`, true);
                    return;
                }

                displayEdgarCompanyInfo(companyInfo);

                const cik = companyInfo.cik_str;
                if (statusDiv) {
                    statusDiv.textContent = `Fetching company facts for CIK: ${cik}...`; 
                    statusDiv.className = 'alert alert-info mt-3'; 
                    statusDiv.style.display = 'block';
                }

                const factsResponse = await fetch(`/api/v3/edgar/company-facts/${cik}`);
                if (!factsResponse.ok) {
                    const errorData = await factsResponse.json().catch(() => ({ detail: factsResponse.statusText }));
                    throw new Error(errorData.detail || `HTTP error! status: ${factsResponse.status}`);
                }
                const factsData = await factsResponse.json();
                if (factsData) {
                     displayEdgarCompanyFacts(factsData, cik);
                } else {
                    displayEdgarError(`No facts data returned for CIK ${cik}.`, true);
                }

            } catch (error) {
                console.error('EDGAR Data Fetch Error:', error);
                displayEdgarError(`EDGAR Data Fetch Error: ${error.message}`);
            }
        });
    }

    function clearEdgarResults() {
        const statusDiv = document.getElementById('edgarStatusDiv');
        const resultsDiv = document.getElementById('edgarResultsDiv');
        const jsonOutput = document.getElementById('edgarJsonOutput');
        const factsTableContainer = document.getElementById('edgarFactsTableContainer');
        const factsTable = document.getElementById('edgarFactsTable');
        const exportBtn = document.getElementById('exportEdgarFactsBtn'); // Get export button

        if (statusDiv) {
            statusDiv.style.display = 'none';
            statusDiv.textContent = '';
            statusDiv.className = 'mt-3'; 
        }
        if (resultsDiv) resultsDiv.style.display = 'none';
        if (jsonOutput) jsonOutput.textContent = '';
        if (factsTableContainer) factsTableContainer.style.display = 'none';
        if (factsTable) {
            const thead = factsTable.querySelector('thead');
            const tbody = factsTable.querySelector('tbody');
            if (thead) thead.innerHTML = '';
            if (tbody) tbody.innerHTML = '';
        }
        // Hide export button on clear
        if (exportBtn) {
            exportBtn.style.display = 'none';
        }
        currentEdgarExportContext = { cik: null, ticker: null }; // Clear context
    }

    function displayEdgarError(message, isWarning = false) {
        const statusDiv = document.getElementById('edgarStatusDiv');
        const resultsDiv = document.getElementById('edgarResultsDiv');
        const jsonOutput = document.getElementById('edgarJsonOutput');
        const factsTableContainer = document.getElementById('edgarFactsTableContainer');
        const exportBtn = document.getElementById('exportEdgarFactsBtn'); // Get export button

        if (resultsDiv) resultsDiv.style.display = 'none';
        if (jsonOutput) jsonOutput.textContent = '';
        if (factsTableContainer) factsTableContainer.style.display = 'none';
        if (exportBtn) exportBtn.style.display = 'none'; // Hide export button on error

        if (statusDiv) {
            statusDiv.textContent = message;
            statusDiv.className = `alert ${isWarning ? 'alert-warning' : 'alert-danger'} mt-3`;
            statusDiv.style.display = 'block';
        }
    }

    function displayEdgarCompanyInfo(data) {
        const resultsDiv = document.getElementById('edgarResultsDiv');
        const jsonOutput = document.getElementById('edgarJsonOutput');
        const statusDiv = document.getElementById('edgarStatusDiv');
        
        if (jsonOutput) jsonOutput.textContent = JSON.stringify(data, null, 2);
        if (resultsDiv) resultsDiv.style.display = 'block';
        if (statusDiv) statusDiv.style.display = 'none'; 

        if (window.hljs && jsonOutput) {
            hljs.highlightElement(jsonOutput);
        }
    }

    function displayEdgarCompanyFacts(factsData, cik) {
        const factsTableContainer = document.getElementById('edgarFactsTableContainer');
        const factsTable = document.getElementById('edgarFactsTable');
        const statusDiv = document.getElementById('edgarStatusDiv');
        const exportBtn = document.getElementById('exportEdgarFactsBtn'); // Get export button

        if (!factsData || !factsData.facts || !factsData.facts['us-gaap']) {
            displayEdgarError(`No 'us-gaap' facts found for CIK ${cik}.`);
            if (exportBtn) exportBtn.style.display = 'none'; // Hide on error
            return;
        }

        const usGaapFacts = factsData.facts['us-gaap'];
        const allPeriods = new Set();
        const dataByLabel = {};

        for (const factKey in usGaapFacts) {
            const fact = usGaapFacts[factKey];
            const label = fact.label;
            if (!label) continue;

            if (!dataByLabel[label]) {
                dataByLabel[label] = {
                    description: fact.description,
                    units: {}
                };
            }

            if (fact.units && typeof fact.units === 'object') {
                for (const unitKey in fact.units) {
                    const unitEntries = fact.units[unitKey];
                    if (Array.isArray(unitEntries)) {
                        unitEntries.forEach(entry => {
                            const periodIdentifier = `${entry.fp}|${entry.fy}|${entry.form}|${entry.end}`;
                            allPeriods.add(periodIdentifier);
                            if (!dataByLabel[label].units[periodIdentifier]) {
                                 dataByLabel[label].units[periodIdentifier] = {};
                            }
                            dataByLabel[label].units[periodIdentifier][unitKey] = entry.val;
                        });
                    }
                }
            }
        }

        const sortedPeriods = Array.from(allPeriods).sort((a, b) => {
            const [fpA, fyA, formA, endA] = a.split('|');
            const [fpB, fyB, formB, endB] = b.split('|');
            
            // Primary sort: Fiscal Year
            if (fyA !== fyB) return parseInt(fyA) - parseInt(fyB);
            // Secondary sort: End Date
            const dateA = new Date(endA);
            const dateB = new Date(endB);
            if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
            // Tertiary sort: Fiscal Period (e.g., Q1, Q2, FY)
            if (fpA !== fpB) return fpA.localeCompare(fpB);
            // Quaternary sort: Form type (e.g., 10-K, 10-Q)
            return formA.localeCompare(formB);
        });

        if (!factsTable) return; 
        const thead = factsTable.querySelector('thead');
        const tbody = factsTable.querySelector('tbody');
        if (!thead || !tbody) return;

        thead.innerHTML = '';
        const headerRow = thead.insertRow();
        const thLabel = document.createElement('th');
        thLabel.textContent = 'Metric (Label)';
        thLabel.setAttribute('scope', 'col');
        headerRow.appendChild(thLabel);

        sortedPeriods.forEach(period => {
            const thPeriod = document.createElement('th');
            const [fp, , , endDateString] = period.split('|'); // Extract fp and endDateString
            thPeriod.textContent = `${fp}-${endDateString}`;
            thPeriod.setAttribute('scope', 'col');
            headerRow.appendChild(thPeriod);
        });

        tbody.innerHTML = '';
        const sortedLabels = Object.keys(dataByLabel).sort();

        sortedLabels.forEach(label => {
            const row = tbody.insertRow();
            const cellLabel = row.insertCell();
            cellLabel.textContent = label;
            cellLabel.setAttribute('title', dataByLabel[label].description);

            sortedPeriods.forEach(period => {
                const cellValue = row.insertCell();
                const periodData = dataByLabel[label].units[period];
                if (periodData) {
                    const unitKeys = Object.keys(periodData);
                    if (unitKeys.length > 0) {
                        let displayVal = periodData[unitKeys[0]];
                        if (typeof displayVal === 'number') {
                            if (Math.abs(displayVal) >= 1e6) {
                                displayVal = (displayVal / 1e6).toFixed(2) + 'M';
                            } else if (Math.abs(displayVal) >= 1e3) {
                                displayVal = (displayVal / 1e3).toFixed(2) + 'K';
                            } else {
                                displayVal = displayVal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
                            }
                        }
                        cellValue.textContent = displayVal;
                        cellValue.setAttribute('title', `Unit: ${unitKeys[0]}`); // Restored this line
                    } else {
                        cellValue.textContent = 'N/A';
                    }
                } else {
                    cellValue.textContent = 'N/A';
                }
            });
        });

        if (factsTableContainer) factsTableContainer.style.display = 'block';
        if (statusDiv) {
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-success mt-3';
            statusDiv.textContent = `Successfully displayed facts for CIK ${cik}. Found ${sortedLabels.length} metrics across ${sortedPeriods.length} periods.`;
        }
        // Show and update context for export button
        if (exportBtn) {
            exportBtn.style.display = 'inline-block';
            currentEdgarExportContext.cik = cik;
            currentEdgarExportContext.ticker = document.getElementById('edgarTickerInput').value.trim().toUpperCase();
        }
    }

    // --- Theme Toggle Logic --- 
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            document.cookie = `theme_preference=${newTheme};path=/;max-age=${30*24*60*60}`; // Expires in 30 days
        });
    }

    (function() {
        const preferredTheme = document.cookie.split('; ').find(row => row.startsWith('theme_preference='))?.split('=')[1];
        if (preferredTheme) {
            document.documentElement.setAttribute('data-bs-theme', preferredTheme);
        }
    })();

    // --- XLS Export Function ---
    function exportTableToXLS(tableId, filename) {
        const table = document.getElementById(tableId);
        if (!table || !table.rows || table.rows.length === 0) {
            console.error('Table not found or empty for export:', tableId);
            alert('No data available to export.');
            return;
        }

        const tableClone = table.cloneNode(true);
        // Remove any interactive elements or classes not needed for export if any (e.g. tooltips)
        // For this table, it's fairly clean.

        let tableHTML = tableClone.outerHTML;

        const template = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office"
                  xmlns:x="urn:schemas-microsoft-com:office:excel"
                  xmlns="http://www.w3.org/TR/REC-html40">
            <head>
                <meta charset="UTF-8">
                <!--[if gte mso 9]>
                <xml>
                    <x:ExcelWorkbook>
                        <x:ExcelWorksheets>
                            <x:ExcelWorksheet>
                                <x:Name>Sheet1</x:Name>
                                <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
                            </x:ExcelWorksheet>
                        </x:ExcelWorksheets>
                    </x:ExcelWorkbook>
                </xml>
                <![endif]-->
                <style>
                    /* Basic styling for Excel */
                    table, th, td { border: 1px solid black; border-collapse: collapse; }
                    th, td { padding: 5px; text-align: left; }
                    th { background-color: #f2f2f2; }
                </style>
            </head>
            <body>
                ${tableHTML}
            </body>
            </html>`;

        const dataType = 'application/vnd.ms-excel';
        const blob = new Blob([template], { type: dataType });
        const downloadLink = document.createElement("a");

        document.body.appendChild(downloadLink); // Required for Firefox

        if (navigator.msSaveOrOpenBlob) { // For IE / Edge
            navigator.msSaveOrOpenBlob(blob, filename);
        } else {
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = filename;
            downloadLink.click();
            URL.revokeObjectURL(downloadLink.href); // Clean up
        }
        document.body.removeChild(downloadLink);
    }
});
</script>
{% endblock %}
