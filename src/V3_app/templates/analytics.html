{% extends "base.html" %}

{% block title %}Analytics - Financial App V3{% endblock %}

{% block head_extra %}
    {# Add any page-specific CSS or meta tags here if needed later #}
    {# --- Add Chart.js CDN --- #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    {# --- Add Zoom Plugin CDN --- #}
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    {# --- End Chart.js CDN --- #}
    {# --- DataTables CSS --- #}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    {# <<< ADD DataTables Buttons CSS >>> #}
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
    {# <<< ADD DataTables RowGroup CSS >>> #}
    <link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.5.1/css/rowGroup.bootstrap5.min.css">
    {# --- End DataTables CSS --- #}
    <style>
        /* Style for filter rows */
        .filter-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 1px solid var(--bs-border-color-translucent);
            border-radius: 0.25rem;
        }
        .filter-row select,
        .filter-row input {
            margin-right: 0.5rem;
        }
        /* Style for output area */
        #processed-analytics-output {
            background-color: var(--bs-body-bg); /* Use CSS var for theme adapt */
            border: 1px solid var(--bs-border-color); /* Use CSS var for theme adapt */
            color: var(--bs-body-color); /* Ensure text color matches theme */
            padding: 15px;
            margin-top: 15px;
            max-height: 600px; /* Increased height */
            overflow-y: auto;
            white-space: pre-wrap; /* Allow wrapping */
            word-wrap: break-word; /* Break long words/strings */
            font-family: monospace; /* Good for JSON */
            font-size: 0.85rem;
        }
        /* Style for drag-and-drop area */
        #drop-zone {
            border: 2px dashed var(--bs-secondary-color);
            border-radius: 0.375rem; /* Match Bootstrap's default border radius */
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            background-color: var(--bs-tertiary-bg);
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        #drop-zone.dragover {
            border-color: var(--bs-primary);
            background-color: var(--bs-primary-bg-subtle);
        }
        #drop-zone p {
            margin-bottom: 0;
            color: var(--bs-body-color); /* Use main body color for better contrast */
        }

        /* <<< NEW: Filtered Table UI Improvements >>> */
        /* Remove column separators in filtered table */
        #output-table th,
        #output-table td {
            border-right: none;
        }
        #output-table th:first-child,
        #output-table td:first-child {
            border-left: none; /* Also remove left border on first column */
        }
        /* Cross-highlight styles - UPDATED COLORS */
        #output-table tbody tr.row-highlight td,
        #output-table tbody td.col-highlight {
            background-color: var(--bs-primary-bg-subtle) !important; /* Use subtle primary blue for row/col */
        }
        #output-table tbody tr.row-highlight td.col-highlight {
            background-color: var(--bs-info-bg-subtle) !important;    /* Use subtle info (usually lighter blue/cyan) for intersection */
        }
        /* Ensure text contrast on highlight, especially dark mode */
        [data-bs-theme="dark"] #output-table tbody tr.row-highlight td,
        [data-bs-theme="dark"] #output-table tbody td.col-highlight,
        [data-bs-theme="dark"] #output-table tbody tr.row-highlight td.col-highlight {
            color: var(--bs-body-emphasis-color) !important; /* Ensure contrast for all highlights */
        }

        /* Duplicate highlight styles for final data table */
        #final-data-table th,
        #final-data-table td {
            border-right: none;
        }
        #final-data-table th:first-child,
        #final-data-table td:first-child {
            border-left: none;
        }
        #final-data-table tbody tr.row-highlight td,
        #final-data-table tbody td.col-highlight {
            background-color: var(--bs-primary-bg-subtle) !important;
        }
        #final-data-table tbody tr.row-highlight td.col-highlight {
            background-color: var(--bs-info-bg-subtle) !important;
        }
        [data-bs-theme="dark"] #final-data-table tbody tr.row-highlight td,
        [data-bs-theme="dark"] #final-data-table tbody td.col-highlight,
        [data-bs-theme="dark"] #final-data-table tbody tr.row-highlight td.col-highlight {
            color: var(--bs-body-emphasis-color) !important;
        }

        /* Optional: slightly shift buttons down to align better with search */
        div.dataTables_wrapper div.dt-buttons {
            padding-top: 0.25rem; /* Adjust as needed */
            margin-left: 0.5rem; /* Add space from search */
        }
        /* <<< END NEW >>> */

        /* <<< NEW: Style for negative numbers >>> */
        .text-negative {
            color: var(--bs-danger) !important; /* Use Bootstrap's danger color (red) */
            /* font-weight: bold; */ /* Optional: Make it bold */
        }
        /* <<< END NEW >>> */

        /* <<< NEW: Class to hide rows for search filter >>> */
        .search-hidden {
            display: none !important;
        }
        /* <<< END NEW >>> */

        /* <<< NEW: Scenario Table Hover Highlight >>> */
        #analytics-scenarios-table tbody tr:hover td { /* Target TDs inside hovered TR */
            background-color: var(--bs-primary-bg-subtle) !important; /* Use subtle primary (usually blue) */
            color: var(--bs-emphasis-color) !important;         /* Use emphasis color for text contrast */
        }
        /* <<< END NEW >>> */

        /* <<< NEW: Popover Visual Summary Styles >>> */
        .summary-visual-container {
            min-height: 30px; /* Ensure space for markers */
        }
        .summary-line {
            width: 100%;
            height: 3px;
            background-color: var(--bs-secondary-bg);
            border: 1px solid var(--bs-secondary-color);
            position: absolute;
            bottom: 10px; /* Position line vertically */
            left: 0;
            border-radius: 2px;
        }
        .summary-marker {
            position: absolute;
            bottom: 11px; /* Align tip just ABOVE the line */
            width: 0;
            height: 0;
            border-left: 6px solid transparent; /* Creates left side of triangle */
            border-right: 6px solid transparent; /* Adjust size as needed */
            border-bottom: none; /* Explicitly no bottom border */
            /* border-top will set the color and size */
            transform: translateX(-50%); /* Center the marker horizontally */
            z-index: 1; /* Ensure markers are above the line */
        }
        .marker-min, .marker-max { border-top: 8px solid var(--bs-secondary); }
        .marker-avg { border-top: 8px solid var(--bs-warning); }
        .marker-value { border-top: 8px solid var(--bs-primary); }
        /* Ensure popover allows enough width */
        .analytics-summary-popover {
            min-width: 250px; /* Adjust as needed */
            max-width: 350px; /* Adjust as needed */
        }
        /* <<< END NEW >>> */

        /* <<< NEW: Styles for the larger value marker >>> */
        .summary-marker.marker-value-large {
            border-top-width: 12px; /* Increased height */
            border-left-width: 9px; /* Increased width */
            border-right-width: 9px; /* Increased width */
             /* Keep bottom: 10px; from .summary-marker to align tip */
             /* Keep transform: translateX(-50%); from .summary-marker */
        }
        /* <<< END NEW >>> */

    </style>
{% endblock %}

{% block content %}
    {# Analytics Page Content #}
    <h1>Analytics</h1>
    <p>import, process, filter, configure, and report on financial data.</p>

    {# --- Main Workflow Tabs --- #}
    <ul class="nav nav-tabs mt-3" id="mainWorkflowTabs" role="tablist">
        {# === Renamed Configuration -> Scenarios Tab === #}
        <li class="nav-item" role="presentation">
            {# REMOVED active, set aria-selected false #}
            <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-tab-pane" type="button" role="tab" aria-controls="config-tab-pane" aria-selected="false"><i class="bi bi-file-earmark-text me-1"></i> Scenarios</button> {# Renamed Text #}
        </li>
        {# === END: Scenarios Tab === #}
        <li class="nav-item" role="presentation">
            {# Renamed Fetch -> Data Sources, removed active, updated target/controls #}
            <button class="nav-link" id="data-sources-tab" data-bs-toggle="tab" data-bs-target="#data-sources-tab-pane" type="button" role="tab" aria-controls="data-sources-tab-pane" aria-selected="false"><i class="bi bi-cloud-arrow-down me-1"></i> Data Sources</button>
        </li>
        <li class="nav-item" role="presentation">
             {# Update attributes and text for Data Load #}
            <button class="nav-link active" id="data-load-tab" data-bs-toggle="tab" data-bs-target="#data-load-tab-pane" type="button" role="tab" aria-controls="data-load-tab-pane" aria-selected="true"><i class="bi bi-filter-square me-1"></i> Data Ingest</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="transform-tab" data-bs-toggle="tab" data-bs-target="#transform-tab-pane" type="button" role="tab" aria-controls="transform-tab-pane" aria-selected="false"><i class="bi bi-gear me-1"></i> Data Transformation</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="data-visual-tab" data-bs-toggle="tab" data-bs-target="#data-visual-pane" type="button" role="tab" aria-controls="data-visual-pane" aria-selected="false"><i class="bi bi-bar-chart-line me-1"></i> Data Visual</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="data-table-tab" data-bs-toggle="tab" data-bs-target="#data-table-pane" type="button" role="tab" aria-controls="data-table-pane" aria-selected="false"><i class="bi bi-table me-1"></i> Data Table</button>
        </li>
        {# <<< REMOVED Top-Level Filtered Data Tab Button >>> #}
    </ul>
    {# --- End Main Workflow Tabs --- #}

    {# --- Main Tab Content --- #}
    <div class="tab-content pt-3" id="mainWorkflowTabsContent">

        {# === Renamed Configuration -> Scenarios Tab Pane === #}
        {# REMOVED show active #}
        <div class="tab-pane fade" id="config-tab-pane" role="tabpanel" aria-labelledby="config-tab" tabindex="0">
            <h5>Manage Scenarios</h5> {# Renamed Heading #}
            <p>Manage saved sets of Filters, Field Settings, and Transformation Rules.</p>
            
            {# --- Scenario Table --- #}
            <div class="table-responsive mt-3 mb-3" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-sm table-hover" id="analytics-scenarios-table">
                    <thead class="sticky-top"> {# Sticky header, REMOVED table-light #}
                        <tr>
                            <th scope="col">Scenario Name</th>
                            <th scope="col" class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# Scenario rows will be populated by JS #}
                    </tbody>
                </table>
            </div>
            {# --- End Scenario Table --- #}

            {# <<< Reorganized Save/Import section - MOVED BELOW >>> #}

            {# --- Moved Import Section --- #}
            <div class="row mb-3 align-items-center">
                
                {# Left Column: Import Text #}
                <div class="col-md-4"> {# Adjusted width #}
                    <h6>Import Scenario</h6>
                    <p class="small text-muted mb-2">Import a previously exported scenario (.json file).</p>
                </div>

                {# Center Column: Drop Zone #}
                <div class="col-md-6"> {# Adjusted width #}
                    {# Hidden File Input for Import #}
                    <input type="file" id="analytics-scenario-import-input" accept=".json" style="display: none;">
                    {# Import Drop Zone #}
                    <div id="analytics-scenario-import-drop-zone" class="border rounded p-4 text-center mb-0" style="cursor: pointer; border-style: dashed !important; background-color: var(--bs-tertiary-bg);"> 
                        <p class="mb-0">
                            <span class="status-icon bi bi-cloud-arrow-up me-2 align-middle"></span>
                            <span class="status-text">Drag & drop .json file here, or click to select</span>
                        </p>
                    </div>
                </div>

                {# Right Column: (Empty) #}
                <div class="col-md-2 d-flex justify-content-center"> {# Adjusted width #}
                    {# Intentionally Empty #}
                </div>

            </div> {# <<< End row >>> #}
            
            {# Status for import (now below the row) #}
            <div id="analytics-import-status" class="small text-muted text-center mb-3"></div> 
            {# --- End Moved Import Section --- #}

        </div>
        {# === END: Scenarios Tab Pane === #}

        {# --- Data Sources Tab Pane (Renamed from Fetch) --- #}
        <div class="tab-pane fade" id="data-sources-tab-pane" role="tabpanel" aria-labelledby="data-sources-tab" tabindex="0">
            <h5>Data Import Sources</h5>
            <p>Import raw data from external sources.</p>

            {# --- Finviz Import Card --- #}
            <div class="my-3 p-3 border rounded bg-body-tertiary">
                <h5 class="mb-3">Import from Finviz</h5>
                <div class="row gy-3"> {# Use row with gutter spacing #}
                    
                    {# --- Column 1: Screened Tickers --- #}
                    <div class="col-md-6">
                        <h6>All Tracked Tickers</h6>
                        <p class="small text-muted mb-2">Fetch data for tickers currently in the <strong>tracker list</strong>.</p>
                        <button id="run-finviz-btn" class="btn btn-primary" style="max-width: 200px;">
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span> <!-- Spinner -->
                            <span class="button-text">Fetch Tracked</span> <!-- Text -->
                        </button>
                         <span id="finviz-status" class="ms-1 mt-1 d-block small"></span> {# Moved status below button #}
                    </div>
                    {# --- End Column 1 --- #}

                    {# --- Column 2: Custom List --- #}
                    <div class="col-md-6">
                        <h6>Custom List</h6>
                        <p class="small text-muted mb-2">Upload a .txt file (one ticker per line).</p>
                        
                        {# Button First #}
                        <button id="run-finviz-upload-btn" class="btn btn-primary mb-2" disabled style="max-width: 200px;">
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span> <!-- Spinner -->
                            <span class="button-text">Fetch Uploaded</span> <!-- Text -->
                        </button>
                        <span id="finviz-upload-status" class="ms-1 mt-1 d-block small mb-2"></span> {# Status below button #}

                        {# Hidden File Input #}
                        <input type="file" id="ticker-file-input" accept=".txt" style="display: none;">

                        {# Drag and Drop Zone Below Button #}
                        <div id="drop-zone" class="border rounded p-4 text-center" style="cursor: pointer; border-style: dashed !important; background-color: var(--bs-tertiary-bg);">
                            <p class="mb-0">
                                <span class="status-icon bi bi-cloud-arrow-up me-2 align-middle"></span>
                                <span class="status-text">Drag & drop .txt file or click</span>
                            </p>
                        </div>
                        
                    </div>
                    {# --- End Column 2 --- #}
                </div>
            </div>
            {# --- End Finviz Import Card --- #}

            {# --- Placeholder for Future Import Sources --- #}
            <!-- 
            <div class="my-3 p-3 border rounded bg-body-tertiary">
                <h5 class="mb-3">Import from [Other Source]</h5>
                </div>
            -->
            {# --- End Placeholder --- #}

        </div>
        {# --- End Data Sources Tab Pane --- #}

        {# --- Data Load Tab Pane (Renamed from Data Preparation) --- #}
        {# Update id and aria-labelledby #}
        <div class="tab-pane fade show active" id="data-load-tab-pane" role="tabpanel" aria-labelledby="data-load-tab" tabindex="0">
            <h5>Data Load Steps</h5> {# Updated heading #}
            <p>Process, clean, filter, and configure the imported data.</p>

            {# --- Raw Analytics Data Processing, Filtering & Configuration --- #}
            <div class="my-3 p-3 border rounded bg-body-tertiary">
                {# REMOVED <h6>Process, Filter & Configure Raw Analytics Data</h6> #}

                {# --- Sub-Tab Navigation for Prep Steps --- #}
                <ul class="nav nav-tabs mt-3" id="prepStepsTabs" role="tablist">
                    {# --- NEW: Load Data Sub-Tab Button --- #}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="load-data-subtab" data-bs-toggle="tab" data-bs-target="#load-data-subtab-pane" type="button" role="tab" aria-controls="load-data-subtab-pane" aria-selected="true">Load Data</button>
                    </li>
                    {# --- End Load Data Sub-Tab Button --- #}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="config-subtab" data-bs-toggle="tab" data-bs-target="#config-subtab-pane" type="button" role="tab" aria-controls="config-subtab-pane" aria-selected="false">Field Configuration</button> {# Removed active, set aria-selected false #}
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="filter-subtab" data-bs-toggle="tab" data-bs-target="#filter-subtab-pane" type="button" role="tab" aria-controls="filter-subtab-pane" aria-selected="false">Filters</button> {# Renamed from Filters & Output #}
                    </li>
                    {# <<< NEW: Filtered Data Sub-Tab Button >>> #}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="filtered-data-subtab" data-bs-toggle="tab" data-bs-target="#filtered-data-subtab-pane" type="button" role="tab" aria-controls="filtered-data-subtab-pane" aria-selected="false">Filtered Data</button>
                    </li>
                    {# <<< END NEW >>> #}
                </ul>
                {# --- End Sub-Tab Navigation --- #}

                {# --- Sub-Tab Content --- #}
                <div class="tab-content pt-3" id="prepStepsTabsContent">

                    {# --- NEW: Load Data Sub-Tab Pane --- #}
                    <div class="tab-pane fade show active" id="load-data-subtab-pane" role="tabpanel" aria-labelledby="load-data-subtab" tabindex="0">
                        <h6>Load Data</h6>
                        <p class="small text-muted">Load and process all raw analytics data currently stored in the database.</p>
                        {# Moved Button and Status Here #}
                        <button id="process-analytics-data-btn" class="btn btn-secondary me-2">
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span> <!-- Spinner -->
                            <span class="button-text">Load Data from DB</span> <!-- Text -->
                        </button>
                        <span id="process-analytics-status" class="ms-2"></span> {# Status for the processing action #}
                    </div>
                    {# --- End Load Data Sub-Tab Pane --- #}

                    {# --- Field Configuration Sub-Tab Pane --- #}
                    <div class="tab-pane fade" id="config-subtab-pane" role="tabpanel" aria-labelledby="config-subtab" tabindex="0"> {# Removed show active #}

                        {# Container for Field Weights & Toggles #}
                        <div class="mb-3">
                            <!-- REMOVED Field Configuration H6 heading -->
                            <div id="field-config-container" style="max-height: 400px; overflow-y: auto;"> <!-- Increased height slightly -->
                                <!-- Field config rows will be added here dynamically -->
                                <p class="text-muted small">Load data to configure fields.</p>
                            </div>
                        </div>

                    </div>
                    {# --- End Field Configuration Sub-Tab Pane --- #}

                    {# --- Filters & Output Sub-Tab Pane --- #}
                    <div class="tab-pane fade" id="filter-subtab-pane" role="tabpanel" aria-labelledby="filter-subtab" tabindex="0">

                        {# Filter Controls #}
                        <div class="mb-3">
                            <div id="filter-controls-container">
                                <!-- Filter rows will be added here dynamically -->
                            </div>
                            <button id="add-filter-btn" class="btn btn-sm btn-outline-success me-2">+ Add Filter</button>
                            <button id="apply-filters-btn" class="btn btn-sm btn-primary me-2">Apply Filters</button>
                            <button id="reset-filters-btn" class="btn btn-sm btn-outline-danger">Reset Filters</button>
                        </div>

                        {# Display area for processed output - MOVED TO SEPARATE SUB-TAB #}

                    </div>
                    {# --- End Filters Sub-Tab Pane --- #}

                    {# <<< NEW: Filtered Data Sub-Tab Pane >>> #}
                    <div class="tab-pane fade" id="filtered-data-subtab-pane" role="tabpanel" aria-labelledby="filtered-data-subtab" tabindex="0">
                        {# Content moved here #}
                        <div id="processed-analytics-output-container" class="mt-3">
                            <span id="filter-results-count" class="ms-2 small text-muted"></span>
                            <div class="table-responsive mt-2"> {# Make table horizontally scrollable on small screens #}
                                <table id="output-table" class="table table-striped table-bordered table-sm compact display" style="width:100%">
                                     <thead>
                                         {# Table headers will be added dynamically by JS #}
                                         <tr>
                                             {# Placeholder - will be replaced #}
                                             <th>Loading...</th>
                                         </tr>
                                     </thead>
                                     <tbody>
                                         {# Table body content will be added dynamically by JS #}
                                         {# Add a placeholder row or message? #}
                                         <tr>
                                             <td class="text-center text-muted small">Apply filters to view data.</td>
                                         </tr>
                                     </tbody>
                                </table>
                            </div>
                            {# --- End Table --- #}
                        </div>
                    </div>
                    {# <<< END NEW >>> #}

                </div>
                {# --- End Sub-Tab Content --- #}

            </div>
            {# --- END Raw Analytics Data Processing, Filtering & Configuration --- #}

            {# Add other prep steps here later #}

        </div>
        {# --- End Data Load Tab Pane --- #}

        {# --- NEW Transform Tab Pane --- #}
        <div class="tab-pane fade" id="transform-tab-pane" role="tabpanel" aria-labelledby="transform-tab" tabindex="0">
            <h5>Data Transformation</h5>
            {# <p>Apply transformations, calculations, or feature engineering to the prepared data.</p> <-- Moved #}

            {# --- Sub-Tabs for Transform --- #}
            <ul class="nav nav-tabs mt-3" id="transformSubTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="transform-rules-subtab" data-bs-toggle="tab" data-bs-target="#transform-rules-subtab-pane" type="button" role="tab" aria-controls="transform-rules-subtab-pane" aria-selected="true">Rules</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="transform-output-subtab" data-bs-toggle="tab" data-bs-target="#transform-output-subtab-pane" type="button" role="tab" aria-controls="transform-output-subtab-pane" aria-selected="false">Output Formatting</button>
                </li>
            </ul>
            {# --- End Sub-Tab Navigation --- #}

            {# --- Sub-Tab Content --- #}
            <div class="tab-content pt-3" id="transformSubTabsContent">

                {# --- Rules Sub-Tab Pane --- #}
                <div class="tab-pane fade show active" id="transform-rules-subtab-pane" role="tabpanel" aria-labelledby="transform-rules-subtab" tabindex="0">
                    <p>Define transformations, calculations, or feature engineering steps.</p> {# Moved description #}
                    {# <<< MOVED EXISTING CONTENT INSIDE HERE >>> #}
                    <div class="my-3 p-3 border rounded bg-body-tertiary">
                        <div class="row">
                            {# --- Column 1: Rule Definition & Controls --- #}
                            <div class="col-md-6">
                                <h6>Define Transformations</h6>
                                <div id="transformation-rules-container" class="mb-3" style="min-height: 200px; max-height: 400px; overflow-y: auto; border: 1px solid var(--bs-border-color); padding: 10px; background-color: var(--bs-body-bg);">
                                    <p class="text-muted small">No transformations defined yet. Click "+ Add Rule" to begin.</p>
                                    <!-- Transformation rules will be listed here dynamically -->
                                </div>
                                <div class="mb-3"> {# Button Group #}
                                    <button id="add-transformation-rule-btn" class="btn btn-sm btn-outline-success me-2" data-bs-toggle="modal" data-bs-target="#transformationRuleModal">
                                        <i class="bi bi-plus-lg"></i> Add Rule
                                    </button>
                                    <button id="apply-transformations-btn" class="btn btn-sm btn-primary me-2">
                                        <i class="bi bi-play-fill"></i> 
                                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span> <!-- Spinner -->
                                        <span class="button-text">Apply Transformations</span> <!-- Text -->
                                    </button>
                                     {# Placeholder for future buttons #}
                                    <button id="save-transform-rules-btn" class="btn btn-sm btn-outline-secondary me-1" title="Save Rules to Browser"><i class="bi bi-save"></i></button>
                                    <button id="load-transform-rules-btn" class="btn btn-sm btn-outline-secondary me-1" title="Load Rules from Browser"><i class="bi bi-folder2-open"></i></button>
                                </div>
                                <div id="transform-status" class="mt-2 small text-muted"></div> {# Status message area #}
                            </div>
                            {# --- Column 2: Data Preview --- #}
                            <div class="col-md-6">
                                <h6>Transformed Data Preview (First 10 Rows)</h6>
                                <pre id="transformed-data-output" class="p-2 border rounded" style="max-height: 450px; overflow: auto; font-size: 0.75rem; white-space: pre; word-wrap: normal; background-color: var(--bs-tertiary-bg); color: var(--bs-body-color);"></pre>
                            </div>
                        </div>
                        {# Transformation Rule Editor Modal remains outside sub-tab content #}
                    </div>
                    {# <<< END MOVED CONTENT >>> #}
                </div>
                {# --- End Rules Sub-Tab Pane --- #}

                {# --- Output Formatting Sub-Tab Pane --- #}
                <div class="tab-pane fade" id="transform-output-subtab-pane" role="tabpanel" aria-labelledby="transform-output-subtab" tabindex="0">
                    <p>Configure formatting and visibility for fields after transformations have been applied.</p>
                    <div class="my-3 p-3 border rounded bg-body-tertiary">
                        <div id="output-formatting-container">
                            <p class="text-muted small">Run transformations to configure the output formatting.</p>
                            <!-- Post-transform formatting UI will be added here dynamically -->

                            {# --- NEW: Post-Transformation Field Configuration --- #}
                            <div id="post-transform-field-config-container" class="mt-3" style="max-height: 400px; overflow-y: auto;"> <!-- Added inline styles for scrolling -->
                                <table class="table table-sm table-striped table-hover" id="post-transform-field-config-table">
                                    <thead class="sticky-top bg-body">
                                        {# Search and Toggle Row #}
                                        <tr>
                                            <th colspan="4"> {# <<< ADJUSTED COLSPAN from 6 to 4 >>> #}
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                                    <input type="text" id="post-transform-field-search" class="form-control form-control-sm" placeholder="Search fields...">
                                                </div>
                                            </th>
                                        </tr>
                                        {# Column Headers Row #}
                                        <tr>
                                            <th scope="col" class="sortable" data-column="name" data-target-tbody="post-transform-field-config-tbody">
                                                Field Name <i class="bi bi-arrow-down-up small text-muted"></i>
                                            </th>
                                            <th scope="col" class="sortable" data-column="enabled" data-target-tbody="post-transform-field-config-tbody">
                                                Enabled <i class="bi bi-arrow-down-up small text-muted"></i>
                                            </th>
                                            <th scope="col">
                                                Format
                                            </th>
                                            <th scope="col">
                                                Info Tip
                                            </th>
                                            {# REMOVED Records and Data Descriptor TH elements #}
                                        </tr>
                                    </thead>
                                    <tbody id="post-transform-field-config-tbody">
                                        {# Field config rows will be added here dynamically by JS #}
                                        <tr><td colspan="4" class="text-muted small text-center">Run transformations first.</td></tr> {# Adjusted colspan #}
                                    </tbody>
                                </table>
                            </div>
                            {# --- END: Post-Transformation Field Configuration --- #}
                        </div>
                    </div>
                </div>
                {# --- End Output Formatting Sub-Tab Pane --- #}

            </div>
            {# --- End Sub-Tab Content --- #}

            {# --- Transformation Rule Editor Modal (Keep it at this level, outside sub-tabs) --- #}
            <div class="modal fade" id="transformationRuleModal" tabindex="-1" aria-labelledby="transformationRuleModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-lg"> {# Larger modal #}
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="transformationRuleModalLabel">Define Transformation Rule</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="transform-rule-id"> {# For editing existing rules #}
                            
                            {# --- Basic Rule Info --- #}
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="transform-rule-type" class="form-label form-label-sm">Rule Type:</label>
                                    <select id="transform-rule-type" class="form-select form-select-sm">
                                        <option value="" selected disabled>-- Select Type --</option>
                                        {# Options will be added dynamically via JS #}
                                        {# Examples:
                                        <option value="arithmetic">Arithmetic Formula</option>
                                        <option value="ratio">Ratio (Field A / Field B)</option>
                                        <option value="weighted_sum">Weighted Sum</option>
                                        <option value="normalize">Normalize (Min/Max)</option>
                                        <option value="conditional_map">Conditional Mapping</option>
                                        <option value="text_concat">Concatenate Text</option>
                                         ... more later ... 
                                        #}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="transform-output-name" class="form-label form-label-sm">New Field Name:</label>
                                    <input type="text" id="transform-output-name" class="form-control form-control-sm" placeholder="e.g., ProfitMargin, NormalizedScore">
                                    <div id="output-name-feedback" class="invalid-feedback small"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="transform-rule-comment" class="form-label form-label-sm">Comment (Optional):</label>
                                <input type="text" id="transform-rule-comment" class="form-control form-control-sm" placeholder="Describe what this rule does">
                            </div>
                            <hr>
                            
                            {# --- Dynamic Parameter Section --- #}
                            <div id="transform-parameters-container">
                                <p class="text-muted small text-center">Select a Rule Type to configure parameters.</p>
                                {# Rule-specific parameters will be injected here by JS #}
                            </div>
                            {# --- End Dynamic Parameter Section --- #}
                            
                        </div>
                        <div class="modal-footer">
                            <span id="transform-modal-status" class="me-auto text-danger small"></span> {# For modal-specific errors #}
                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-sm btn-primary" id="save-transformation-rule-btn">Save Rule</button>
                        </div>
                    </div>
                </div>
            </div>
            {# --- End Modal --- #}
        </div>
        {# --- End Transform Tab Pane --- #}

        {# --- Data Report Tab Pane --- #}
        <div class="tab-pane fade" id="data-visual-pane" role="tabpanel" aria-labelledby="data-visual-tab" tabindex="0">
                        <!-- NESTED TABS START -->
                        <ul class="nav nav-tabs mt-3" id="visualSubTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="field-viz-tab" data-bs-toggle="tab" data-bs-target="#field-viz-tab-pane" type="button" role="tab" aria-controls="field-viz-tab-pane" aria-selected="true">Field Visualization</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="cross-field-viz-tab" data-bs-toggle="tab" data-bs-target="#cross-field-viz-tab-pane" type="button" role="tab" aria-controls="cross-field-viz-tab-pane" aria-selected="false">Cross-Field Visualization</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="visualSubTabContent">
                            <!-- Nested Tab 1: Field Visualization (Existing Chart) -->
                            <div class="tab-pane fade show active" id="field-viz-tab-pane" role="tabpanel" aria-labelledby="field-viz-tab" tabindex="0">
                                <div class="card mt-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                         <h5 class="mb-0">Data Chart</h5>
                                         <span id="chart-status" class="ms-2 small text-muted"></span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <!-- Chart Controls -->
                                            <div class="col-md-2">
                                                <label for="report-chart-type-selector" class="form-label form-label-sm">Chart Type</label>
                                                <select id="report-chart-type-selector" class="form-select form-select-sm">
                                                    <option value="scatter" selected>Scatter</option>
                                                    <option value="line">Line</option>
                                                    <option value="bar">Bar</option>
                                                    <option value="bubble">Bubble</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label for="report-x-axis-selector" class="form-label form-label-sm">X-Axis</label>
                                                <select id="report-x-axis-selector" class="form-select form-select-sm">
                                                    <option value="index" selected>-- Record Index --</option>
                                                    <!-- Options populated by JS -->
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label for="report-field-selector" class="form-label form-label-sm">Y-Axis</label>
                                                <select id="report-field-selector" class="form-select form-select-sm">
                                                    <option value="">-- Select Field --</option>
                                                    <!-- Options populated by JS -->
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label for="report-color-selector" class="form-label form-label-sm">Color by</label>
                                                <select id="report-color-selector" class="form-select form-select-sm">
                                                    <option value="">-- No Variation --</option>
                                                    <!-- Options populated by JS -->
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label for="report-size-selector" class="form-label form-label-sm">Size by (Bubble)</label>
                                                <select id="report-size-selector" class="form-select form-select-sm" disabled>
                                                    <option value="">-- Select Field --</option>
                                                    <!-- Options populated by JS -->
                                                </select>
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                 <button id="reset-chart-btn" class="btn btn-sm btn-outline-secondary me-1" title="Reset Zoom/Pan">
                                                     <i class="bi bi-arrow-counterclockwise"></i>
                                                 </button>
                                                 <button id="swap-axes-btn" class="btn btn-sm btn-outline-secondary" title="Swap X and Y Axes">
                                                     <i class="bi bi-arrow-left-right"></i>
                                                 </button>
                                             </div>
                                        </div>
                                        <!-- Chart Ticker Search -->
                                         <div class="row mb-2">
                                             <div class="col-md-4">
                                                 <div class="input-group input-group-sm">
                                                     <span class="input-group-text"><i class="bi bi-search"></i></span>
                                                     <input type="text" id="chart-ticker-search" class="form-control form-control-sm" placeholder="Highlight Ticker...">
                                                 </div>
                                                 <div id="chart-search-status" class="form-text small text-muted"></div>
                                             </div>
                                         </div>
                                         <!-- Chart Canvas -->
                                         <div class="chart-container mb-3" style="position: relative; height:60vh; width:100%">
                                            <canvas id="report-chart-canvas"></canvas>
                                         </div>
                                    </div>
                                </div>
                            </div>
            
                            <!-- Nested Tab 2: Cross-Field Visualization (New Radar Chart) -->
                            <div class="tab-pane fade" id="cross-field-viz-tab-pane" role="tabpanel" aria-labelledby="cross-field-viz-tab" tabindex="0">
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h5 class="mb-0">Cross-Field Comparison (Radar Chart)</h5>
                                    </div>
                                    <div class="card-body">
                                        {% include 'analytics/_spider_chart_tab.html' %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- NESTED TABS END -->
        </div>
        {# --- End Data Report Tab Pane --- #}

        {# --- NEW: Data Table Tab Pane --- #}
        <div class="tab-pane fade" id="data-table-pane" role="tabpanel" aria-labelledby="data-table-tab" tabindex="0">
            <h5>Transformed Data Exploration</h5>
            <p>Explore the final dataset using the interactive table below.</p> {# UPDATED TEXT #}
            {# --- REPLACED PIVOT PLACEHOLDER WITH DATATABLE STRUCTURE --- #}
            <div id="final-data-table-container" class="mt-3">
                {# --- NEW: Group By Selector --- #}
                <div class="row mb-2 align-items-center">
                    <div class="col-auto">
                        <label for="final-table-group-by-selector" class="col-form-label col-form-label-sm">Group By:</label>
                    </div>
                    <div class="col-auto">
                        <select id="final-table-group-by-selector" class="form-select form-select-sm">
                            <option value="-1" selected>-- No Grouping --</option>
                            {# Options will be populated by JS #}
                        </select>
                    </div>
                </div>
                {# --- END Group By Selector --- #}
                <div id="final-table-status" class="mb-2 small text-muted">Loading table...</div>
                <div class="table-responsive">
                    <table id="final-data-table" class="table table-striped table-bordered table-sm compact display" style="width:100%">
                        <thead>
                            {# Headers will be populated by JS #}
                            <tr><th>Loading...</th></tr>
                        </thead>
                        <tbody>
                            {# Body will be populated by JS #}
                        </tbody>
                    </table>
                </div>
            </div>
            {# --- END REPLACEMENT --- #}
        </div>
        {# --- END NEW: Data Table Tab Pane --- #}

    </div>
    {# --- End Main Tab Content --- #}

    <!-- Add other analytics-specific content here later -->

    {# --- Numeric Format Configuration Modal --- #}
    <div class="modal fade" id="numericFormatModal" tabindex="-1" aria-labelledby="numericFormatModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="numericFormatModalLabel">Configure Format for <span id="format-field-name" class="fw-bold"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="format-current-field"> {# Store field name #}
                    
                    <div class="mb-3 row">
                        <label for="format-decimals" class="col-sm-4 col-form-label col-form-label-sm">Decimals:</label>
                        <div class="col-sm-8">
                            <input type="number" class="form-control form-control-sm" id="format-decimals" min="0" step="1" placeholder="Auto">
                            <div class="form-text form-text-sm">Leave blank for automatic decimal places.</div>
                        </div>
                    </div>

                    <div class="mb-3 row">
                        <label for="format-prefix" class="col-sm-4 col-form-label col-form-label-sm">Prefix:</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control form-control-sm" id="format-prefix" placeholder="e.g., $">
                        </div>
                    </div>

                    <div class="mb-3 row">
                        <label for="format-suffix" class="col-sm-4 col-form-label col-form-label-sm">Suffix:</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control form-control-sm" id="format-suffix" placeholder="e.g., %, K, M">
                        </div>
                    </div>

                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label col-form-label-sm">Separator:</label>
                        <div class="col-sm-8">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="format-use-separator">
                                <label class="form-check-label small" for="format-use-separator">Use thousands separator (e.g., 1,000)</label>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-sm" id="save-format-btn">Save Format</button>
                </div>
            </div>
        </div>
    </div>
    {# --- End Modal --- #}

    {# --- NEW: Reload Scenario Confirmation Modal --- #}
    <div class="modal fade" id="reloadScenarioModal" tabindex="-1" aria-labelledby="reloadScenarioModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reloadScenarioModalLabel">Reload Scenario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Loading scenario "<strong id="reload-scenario-name"></strong>" will apply its settings immediately, overwriting your current Filters, Field Configuration, and Transformation Rules.</p>
                    <p class="small text-warning" id="reload-warning-text"><i class="bi bi-exclamation-triangle-fill me-1"></i> Any unsaved changes to the current settings will be lost unless you save them first.</p>
                </div>
                <div class="modal-footer justify-content-between"> {# Align buttons #}
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <div> {# Group the action buttons #}
                        <button type="button" class="btn btn-sm btn-warning" id="reload-scenario-save-btn">Save Changes & Reload</button>
                        <button type="button" class="btn btn-sm btn-primary" id="reload-scenario-discard-btn">Discard Changes & Reload</button>
                        <button type="button" class="btn btn-sm btn-primary" id="reload-scenario-load-btn" style="display: none;">Load</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {# --- End Reload Scenario Confirmation Modal --- #}

    {# --- NEW: Group Summary Modal --- #}
    <div class="modal fade" id="groupSummaryModal" tabindex="-1" aria-labelledby="groupSummaryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable"> {# Large and scrollable #}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="groupSummaryModalLabel">Group Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="groupSummaryModalBody">
                    {# Content will be populated by JS #}
                    <p class="text-center text-muted">Loading summary...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    {# --- End Group Summary Modal --- #}

{% endblock %}

{% block scripts %}
    {# Keep the page-specific JavaScript here #}
    {# --- DataTables JS (Core + Bootstrap 5) --- #}
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    {# <<< ADD DataTables Buttons JS >>> #}
    <!-- JSZip (required for Excel export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- DataTables Buttons JS -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script> <!-- Needed for copy, csv, excel -->
    {# <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script> #} <!-- Optional: Print button commented out -->
    {# <<< ADD DataTables RowGroup JS >>> #}
    <script src="https://cdn.datatables.net/rowgroup/1.5.1/js/dataTables.rowGroup.min.js"></script>
    <script src="https://cdn.datatables.net/rowgroup/1.5.1/js/rowGroup.bootstrap5.min.js"></script>

    {# --- Chart.js --- #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {# --- Chart.js Zoom Plugin --- #}
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

    {# --- Application Logic --- #}
    <script src="{{ url_for('static', path='js/analytics_config_manager.js') }}"></script> <!-- Load Config Manager First -->
    <script src="{{ url_for('static', path='js/analytics_post_transform.js') }}"></script>
    <script src="{{ url_for('static', path='js/analytics_data_table.js') }}"></script> <!-- Load Data Table Module -->
    <script src="{{ url_for('static', path='js/analytics_transform.js') }}"></script> <!-- Load Transform Logic -->
    <script src="{{ url_for('static', path='js/analytics.js') }}"></script> <!-- Load Main Analytics Logic LAST -->
    <script src="{{ url_for('static', path='js/analytics_spider_chart.js') }}"></script> <!-- ADDED: Spider Chart Logic -->

    {# <<< Add any other page-specific JS files here >>> #}
{% endblock %}

<!-- Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Chart.js Zoom Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<!-- Custom App JS -->
{# REMOVED DUPLICATE SCRIPT TAG FROM HERE #}

</body>
</html>