{% extends "base.html" %}

{% block title %}Configuration - Financial App V3{% endblock %}

{% block head_extra %}
    <style>
        /* --- REMOVED Duplicated Theme CSS --- */

        /* Custom styles specific to this config page */
        .card-header {
            font-weight: bold;
        }
        /* Style for toggle (original bootstrap-toggle, maybe remove if using BS5 switches?) */
        /* .toggle-group label { margin-bottom: 0; } */
        /* .toggle.ios, .toggle-on.ios, .toggle-off.ios { border-radius: 20px; } */
        /* .toggle.ios .toggle-handle { border-radius: 20px; } */
        
        /* General alignment */
        td, th {
             vertical-align: middle;
        }
        
        /* Ensure standard Bootstrap switches in tables are aligned */
        #rulesTable .form-switch .form-check-input {
            /* Adjust margin if needed */ 
        }
        #rulesTable .toggle { /* Style for original bootstrap-toggle */
            min-width: 75px; 
            vertical-align: middle; 
        }
        
        /* --- REMOVED Custom Tab Styles --- */
        
        .tab-content {
            padding: 1rem 0; /* Consistent padding */
        }

        /* --- REMOVED Duplicated Theme Toggle CSS --- */
    </style>
{% endblock %}

{% block content %}
    <div class="container mt-4">

        {# --- REMOVED Navigation Bar (Provided by base.html) --- #}

        <h1 class="mb-4">Application Configuration</h1>

        {# --- REMOVED Alert Message Box and Initial Population Script (Use global #alert-placeholder and showAlert) --- #}

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-3" id="configTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="scheduler-tab" data-bs-toggle="tab" data-bs-target="#scheduler-pane" type="button" role="tab" aria-controls="scheduler-pane" aria-selected="true">Scheduler</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rates-tab" data-bs-toggle="tab" data-bs-target="#rates-pane" type="button" role="tab" aria-controls="rates-pane" aria-selected="false">Exchange Rates</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules-pane" type="button" role="tab" aria-controls="rules-pane" aria-selected="false">Portfolio Rules</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications-pane" type="button" role="tab" aria-controls="notifications-pane" aria-selected="false">Notifications</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="configTabContent">

            <!-- Scheduler Pane (Renamed) -->
            <div class="tab-pane fade show active" id="scheduler-pane" role="tabpanel" aria-labelledby="scheduler-tab" tabindex="0">
                
                {# --- IBKR Fetch Card (Reverted to inline JS) --- #}
                <div class="mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>IB fetch - account data</span>
                             <div class="form-check form-switch">
                                <input class="form-check-input job-active-toggle" type="checkbox" role="switch" 
                                       id="ibkr-fetch-active-switch"
                                       data-job-id="ibkr_fetch" 
                                       {% if ibkr_fetch_is_active %}checked{% endif %} 
                                       data-bs-toggle="tooltip" data-bs-placement="top" 
                                       title="Enable/Disable scheduled account data pull from IBKR">
                                <label class="form-check-label" for="ibkr-fetch-active-switch"><small>Active</small></label>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <small>Set the schedule for pulling account, position, and order data from IBKR using CRON syntax.</small>
                            </p>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control cron-input-hover-description" 
                                       id="ibkr-fetch-schedule-input" 
                                       placeholder="e.g., 0 */2 * * * (every 2 hours)" 
                                       aria-label="IBKR account data pull schedule"
                                       value="{{ ibkr_fetch_schedule_cron | default('0 * * * *') }}">
                                <button class="btn btn-outline-secondary schedule-update-btn" type="button" 
                                        data-job-id="ibkr_fetch" 
                                        data-input-id="ibkr-fetch-schedule-input"
                                        data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="Update IBKR account data pull schedule">
                                    Update
                                </button>
                            </div>
                            <small class="text-muted">Current schedule: <span id="current-ibkr_fetch-schedule">{{ ibkr_fetch_schedule_cron | default('0 * * * *') }}</span></small>
                            <small class="text-muted d-block">Use standard 5-field cron syntax. <a href="https://crontab.guru/" target="_blank">Help</a></small>
                        </div>
                    </div>
                </div>
                {# --- End IBKR Fetch Card --- #}

                {# --- NEW IBKR Market Snapshot Card (Using inline JS) --- #}
                <div class="mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>IB fetch - market data</span>
                             <div class="form-check form-switch">
                                <input class="form-check-input job-active-toggle" type="checkbox" role="switch" 
                                       id="ibkr-snapshot-active-switch" 
                                       data-job-id="ibkr_sync_snapshot" 
                                       {% if ibkr_snapshot_is_active %}checked{% endif %} 
                                       data-bs-toggle="tooltip" data-bs-placement="top" 
                                       title="Enable/Disable scheduled market data snapshot pull">
                                <label class="form-check-label" for="ibkr-snapshot-active-switch"><small>Active</small></label>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <small>Set the schedule for pulling market data snapshots via sync service using CRON syntax.</small>
                            </p>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control cron-input-hover-description" 
                                       id="ibkr-snapshot-schedule-input" 
                                       placeholder="e.g., */10 * * * * (every 10 mins)" 
                                       aria-label="IBKR snapshot schedule"
                                       value="{{ ibkr_snapshot_schedule_cron | default('*/10 * * * *') }}">
                                <button class="btn btn-outline-secondary schedule-update-btn" type="button" 
                                        data-job-id="ibkr_sync_snapshot" 
                                        data-input-id="ibkr-snapshot-schedule-input"
                                        data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="Update IBKR snapshot schedule">
                                    Update
                                </button>
                            </div>
                            <small class="text-muted">Current schedule: <span id="current-ibkr_sync_snapshot-schedule">{{ ibkr_snapshot_schedule_cron | default('*/10 * * * *') }}</span></small>
                             <small class="text-muted d-block">Use standard 5-field cron syntax. <a href="https://crontab.guru/" target="_blank">Help</a></small>
                        </div>
                    </div>
                </div>
                {# --- End NEW IBKR Market Snapshot Card --- #}
                
                {# --- Harmonized FinViz Card --- #}
                <div class="mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>FinViz Pull Schedule</span>
                             <div class="form-check form-switch">
                                <input class="form-check-input job-active-toggle" type="checkbox" role="switch" 
                                       id="finviz-active-switch" 
                                       data-job-id="finviz_data_fetch" 
                                       {% if finviz_is_active %}checked{% endif %} 
                                       data-bs-toggle="tooltip" data-bs-placement="top" 
                                       title="Enable/Disable scheduled data pull from FinViz">
                                <label class="form-check-label" for="finviz-active-switch"><small>Active</small></label>
                            </div>
                        </div>
                        <div class="card-body">
                             <p class="card-text">
                                <small>Set the schedule for pulling data from FinViz using CRON syntax.</small>
                            </p>
                           <div class="input-group mb-3">
                                <input type="text" class="form-control cron-input-hover-description" 
                                       id="finviz-schedule-input"
                                       placeholder="e.g., 0 3 * * * (daily at 3 AM)"
                                       aria-label="FinViz pull schedule"
                                       value="{{ finviz_schedule_cron | default('0 3 * * *') }}">
                                <button class="btn btn-outline-secondary schedule-update-btn" type="button" 
                                        data-job-id="finviz_data_fetch" 
                                        data-input-id="finviz-schedule-input"
                                        data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="Update FinViz pull schedule">
                                    Update
                                </button>
                            </div>
                            <small class="text-muted">Current schedule: <span id="current-finviz_data_fetch-schedule">{{ finviz_schedule_cron | default('0 3 * * *') }}</span></small>
                             <small class="text-muted d-block">Use standard 5-field cron syntax. <a href="https://crontab.guru/" target="_blank">Help</a></small>
                        </div>
                    </div>
                </div>
                {# --- End Harmonized FinViz Card --- #}

                {# --- Harmonized Yahoo Card --- #}
                <div class="mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Yahoo Data Refresh</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input job-active-toggle" type="checkbox" role="switch" 
                                       id="yahoo-active-switch" 
                                       data-job-id="yahoo_data_fetch" 
                                       {% if yahoo_is_active %}checked{% endif %} 
                                       data-bs-toggle="tooltip" data-bs-placement="top" 
                                       title="Enable/Disable scheduled data pull from Yahoo Finance">
                                <label class="form-check-label" for="yahoo-active-switch"><small>Active</small></label>
                            </div>
                        </div>
                         <div class="card-body">
                            <p class="card-text">
                                <small>Set the calendar schedule for Yahoo data refresh using CRON syntax (e.g., "0 16 * * 1" for Mondays at 4pm).</small>
                            </p>
                             <div class="input-group mb-3">
                                <input type="text" class="form-control cron-input-hover-description" 
                                       id="yahoo-schedule-input"
                                       placeholder="e.g., 0 16 * * 1 (Mon 4pm)"
                                       aria-label="Yahoo data refresh schedule"
                                       value="{{ yahoo_schedule_cron | default('0 1 * * *') }}">
                                <button class="btn btn-outline-secondary schedule-update-btn" type="button" 
                                        data-job-id="yahoo_data_fetch" 
                                        data-input-id="yahoo-schedule-input"
                                        data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="Update Yahoo data refresh schedule">
                                    Update
                                </button>
                            </div>
                             <small class="text-muted">Current schedule: <span id="current-yahoo_data_fetch-schedule">{{ yahoo_schedule_cron | default('0 1 * * *') }}</span></small>
                             <small class="text-muted d-block">Use standard 5-field cron syntax. <a href="https://crontab.guru/" target="_blank">Help</a></small>
                        </div>
                    </div>
                </div>
                {# --- End Harmonized Yahoo Card --- #}
                
                {# --- NEW Analytics Data Cache Refresh Card --- #}
                <div class="mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Analytics Data Cache Refresh</span>
                             <div class="form-check form-switch">
                                <input class="form-check-input job-active-toggle" type="checkbox" role="switch" 
                                       id="analytics-data-cache-active-switch"
                                       data-job-id="analytics_data_cache_refresh" 
                                       {% if analytics_data_cache_refresh_is_active %}checked{% endif %} 
                                       data-bs-toggle="tooltip" data-bs-placement="top" 
                                       title="Enable/Disable scheduled analytics data cache refresh">
                                <label class="form-check-label" for="analytics-data-cache-active-switch"><small>Active</small></label>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <small>Set the schedule for refreshing the analytics data cache (processes Finviz & Yahoo) using CRON syntax.</small>
                            </p>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control cron-input-hover-description" 
                                       id="analytics-data-cache-schedule-input" 
                                       placeholder="e.g., 0 */6 * * * (every 6 hours)" 
                                       aria-label="Analytics data cache refresh schedule"
                                       value="{{ analytics_data_cache_refresh_schedule_cron | default('0 */6 * * *') }}">
                                <button class="btn btn-outline-secondary schedule-update-btn" type="button" 
                                        data-job-id="analytics_data_cache_refresh" 
                                        data-input-id="analytics-data-cache-schedule-input"
                                        data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="Update Analytics Data Cache Refresh schedule">
                                    Update
                                </button>
                                <button class="btn btn-info ms-2" type="button"
                                        onclick="runJobNow('/api/analytics/cache/refresh_data', 'Analytics Data Cache Refresh', this)"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Trigger an immediate refresh of the analytics data cache.">
                                    Run Now
                                </button>
                            </div>
                            <small class="text-muted">Current schedule: <span id="current-analytics_data_cache_refresh-schedule">{{ analytics_data_cache_refresh_schedule_cron | default('0 */6 * * *') }}</span></small>
                             <small class="text-muted d-block">Use standard 5-field cron syntax. <a href="https://crontab.guru/" target="_blank">Help</a></small>
                        </div>
                    </div>
                </div>
                {# --- End Analytics Data Cache Refresh Card --- #}

                {# --- NEW Analytics Metadata Cache Refresh Card --- #}
                <div class="mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Analytics Metadata Cache Refresh</span>
                             <div class="form-check form-switch">
                                <input class="form-check-input job-active-toggle" type="checkbox" role="switch" 
                                       id="analytics-metadata-cache-active-switch"
                                       data-job-id="analytics_metadata_cache_refresh" 
                                       {% if analytics_metadata_cache_refresh_is_active %}checked{% endif %} 
                                       data-bs-toggle="tooltip" data-bs-placement="top" 
                                       title="Enable/Disable scheduled analytics metadata cache refresh">
                                <label class="form-check-label" for="analytics-metadata-cache-active-switch"><small>Active</small></label>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <small>Set the schedule for refreshing the analytics metadata cache (analyzes processed data) using CRON syntax.</small>
                            </p>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control cron-input-hover-description" 
                                       id="analytics-metadata-cache-schedule-input" 
                                       placeholder="e.g., 0 */6 * * * (every 6 hours)" 
                                       aria-label="Analytics metadata cache refresh schedule"
                                       value="{{ analytics_metadata_cache_refresh_schedule_cron | default('0 */6 * * *') }}">
                                <button class="btn btn-outline-secondary schedule-update-btn" type="button" 
                                        data-job-id="analytics_metadata_cache_refresh" 
                                        data-input-id="analytics-metadata-cache-schedule-input"
                                        data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="Update Analytics Metadata Cache Refresh schedule">
                                    Update
                                </button>
                                <button class="btn btn-info ms-2" type="button"
                                        onclick="runJobNow('/api/analytics/cache/refresh_metadata', 'Analytics Metadata Cache Refresh', this)"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Trigger an immediate refresh of the analytics metadata cache.">
                                    Run Now
                                </button>
                            </div>
                            <small class="text-muted">Current schedule: <span id="current-analytics_metadata_cache_refresh-schedule">{{ analytics_metadata_cache_refresh_schedule_cron | default('0 */6 * * *') }}</span></small>
                             <small class="text-muted d-block">Use standard 5-field cron syntax. <a href="https://crontab.guru/" target="_blank">Help</a></small>
                        </div>
                    </div>
                </div>
                {# --- End Analytics Metadata Cache Refresh Card --- #}
                
            </div>

            <!-- Exchange Rates Pane -->
            <div class="tab-pane fade" id="rates-pane" role="tabpanel" aria-labelledby="rates-tab" tabindex="0">
                <div class="card mb-4">
                    <div class="card-header">Exchange Rates (vs EURO)</div>
                    <div class="card-body">
                        <form method="post" id="exchangeRateForm">
                        {% if exchange_rates %}
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Currency</th>
                                        <th>Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for currency, rate in exchange_rates.items() %}
                                    <tr>
                                        <td>{{ currency }}</td>
                                        <td>
                                            {# Display 1/rate to show EUR per foreign unit, as DB stores foreign per EUR for EUR.XXX pairs #}
                                            {% if rate is number and rate != 0 %}
                                                {{ "%.4f"|format(1 / rate) }}
                                            {% elif rate == 0 %}
                                                N/A (rate is 0)
                                            {% else %}
                                                {{ rate }} {# Display as is if not a number (e.g., if it was an error string) #}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {# REMOVE the update button as nothing is editable #}
                            {# <button type="submit" class="btn btn-primary btn-sm mt-2">Update Rates</button> #}
                        {% else %}
                         <p>No exchange rates found.</p>
                        {% endif %}
                        </form>
                        <small class="text-muted mt-2 d-block">Rates are updated periodically.</small> {# Updated message #}
                    </div>
                </div>
            </div>

            <!-- Portfolio Rules Pane -->
            <div class="tab-pane fade" id="rules-pane" role="tabpanel" aria-labelledby="rules-tab" tabindex="0">
                <div class="card mb-4">
                    <div class="card-header">Portfolio Rules</div>
                    <div class="card-body">
                        <button type="button" class="btn btn-success btn-sm mb-3 add-rule-btn" data-bs-toggle="modal" data-bs-target="#ruleModal">
                            <i class="bi bi-plus-circle"></i> Add New Rule
                        </button>
                        <div class="table-responsive">
                            <table class="table table-sm w-100" id="rulesTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Rule Name</th>
                                        <th>Min Value</th>
                                        <th>Max Value</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="rulesTableBody">
                                    {# DataTables populates this #}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Pane -->
            <div class="tab-pane fade" id="notifications-pane" role="tabpanel" aria-labelledby="notifications-tab" tabindex="0">
                
                <!-- Sub-tab navigation for Notifications -->
                <ul class="nav nav-pills mb-3" id="notificationsSubTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="notify-services-tab" data-bs-toggle="tab" data-bs-target="#notify-services-pane" type="button" role="tab" aria-controls="notify-services-pane" aria-selected="true">Services</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notify-tasks-tab" data-bs-toggle="tab" data-bs-target="#notify-tasks-pane" type="button" role="tab" aria-controls="notify-tasks-pane" aria-selected="false">Task Alerts</button>
                    </li>
                </ul>

                <!-- Sub-tab content -->
                <div class="tab-content" id="notificationsSubTabContent">
                    
                    <!-- Services Pane -->
                    <div class="tab-pane fade show active" id="notify-services-pane" role="tabpanel" aria-labelledby="notify-services-tab" tabindex="0">
                <!-- Email Notifications Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Email Notifications</span>
                        <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="email-notifications-active-switch" data-bs-toggle="tooltip" data-bs-placement="top" title="Enable/Disable Email Notifications" disabled>
                            <label class="form-check-label" for="email-notifications-active-switch"><small>Active</small></label>
                        </div>
                    </div>
                            <div class="card-body text-muted">
                                <p class="card-text"><small>Email settings are not yet implemented.</small></p>
                    </div>
                </div>

                <!-- Telegram Notifications Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Telegram Notifications</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="telegram-notifications-active-switch" data-bs-toggle="tooltip" data-bs-placement="top" title="Enable/Disable Telegram Notifications">
                            <label class="form-check-label" for="telegram-notifications-active-switch"><small>Active</small></label>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-text"><small>Configure Telegram Bot settings for sending notifications.</small></p>
                        <form id="telegramConfigForm">
                            <div class="mb-3">
                                <label for="telegramBotToken" class="form-label">Bot Token</label>
                                <input type="password" class="form-control" id="telegramBotToken" name="telegram_bot_token" placeholder="Your Telegram Bot Token">
                            </div>
                            <div class="mb-3">
                                <label for="telegramChatId" class="form-label">Chat ID</label>
                                <input type="text" class="form-control" id="telegramChatId" name="telegram_chat_id" placeholder="Your Telegram Chat ID">
                            </div>
                            <button type="submit" class="btn btn-primary me-2">Save Telegram Settings</button>
                            <button type="button" class="btn btn-info" id="sendTestTelegramBtn">Send Test Notification</button>
                        </form>
                    </div>
                </div>
                    </div> <!-- End Services Pane -->

                    <!-- Task Alerts Pane -->
                    <div class="tab-pane fade" id="notify-tasks-pane" role="tabpanel" aria-labelledby="notify-tasks-tab" tabindex="0">
                <div class="card mb-4">
                    <div class="card-header">
                                <span>Task Completion Notifications</span>
                    </div>
                    <div class="card-body">
                                <p class="card-text"><small>Enable or disable notifications for the completion of specific background tasks. A notification service (like Telegram) must be active and configured to receive these alerts.</small></p>
                                <ul class="list-group" id="task-notification-list">
                                    <!-- JS will populate this list -->
                        </ul>
                    </div>
                </div>
                    </div> <!-- End Task Alerts Pane -->
                </div> <!-- End Sub-tab content -->
            </div>

        </div> <!-- End Tab Content -->

    </div>

    <!-- Rule Add/Edit Modal -->
    <div class="modal fade" id="ruleModal" tabindex="-1" aria-labelledby="ruleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- The form action will be set by JS -->
                <form id="ruleForm" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="ruleModalLabel">Add/Edit Rule</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Hidden field for ID (used for updates) -->
                        <input type="hidden" id="ruleId" name="rule_id">

                        <div class="mb-3">
                            <label for="ruleName" class="form-label">Rule Name</label>
                            <select class="form-select" id="ruleName" name="rule_name" required>
                                <option value="" disabled selected>Select Rule</option>
                                <option value="Portfolio Leverage">Portfolio Leverage</option>
                                <option value="Portfolio Beta">Portfolio Beta</option>
                                <option value="Position Size (% NAV)">Position Size (% NAV)</option>
                                <option value="Position Risk">Position Risk</option>
                                {% for i in range(1, 12) %}
                                <option value="Sector {{ i }} Allocation">Sector {{ i }} Allocation</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="minValue" class="form-label">Min Value</label>
                                <input type="number" step="any" class="form-control" id="minValue" name="min_value" value="0.0" required>
                            </div>
                            <div class="col">
                                <label for="maxValue" class="form-label">Max Value</label>
                                <input type="number" step="any" class="form-control" id="maxValue" name="max_value" value="0.0" required>
                            </div>
                        </div>
                    <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                        </div>
                         <div class="form-check form-switch mb-3">
                             <input class="form-check-input" type="checkbox" role="switch" id="isActiveSwitch" name="is_active_display" value="true" checked> <!-- Use diff name -->
                             <label class="form-check-label" for="isActiveSwitch">Active</label>
                        </div>
                        <!-- Actual hidden field for submission -->
                        <input type="hidden" name="is_active" id="isActiveHidden" value="true">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="saveRuleButton">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %} {# End Content Block #}

{% block scripts %}
    {# Embed initial rules data as JSON #}
    <script type="application/json" id="initial-rules-data">
        {{ portfolio_rules_json | safe }}
    </script>
    {# Add cronstrue library #}
    <script src="{{ url_for('static', path='js/libs/cronstrue.min.js') }}"></script>

    {% raw %}
    <script>
        // Global variable for DataTables instance
        var rulesDataTable = null; 

        // --- Initialize Toggles and Event Handlers ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("[DEBUG Config] DOM loaded.");
            
            // Initialize tooltips (general ones)
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]:not(.cron-input-hover-description)')); // Exclude cron inputs for now
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Initialize CRON description tooltips
            initializeCronDescriptionTooltips();

            // Initialize DataTables
            initializeRulesTable();

            // Populate Task Notification Toggles
            populateTaskNotificationToggles();

            // --- Event Listeners using Delegation ---
            const schedulerPane = document.getElementById('scheduler-pane');
            const rulesTableBody = document.getElementById('rulesTableBody'); 
            const rulesPane = document.getElementById('rules-pane'); // Parent of add button
            const ruleForm = document.getElementById('ruleForm');
            const ruleModal = document.getElementById('ruleModal');
            const isActiveSwitch = document.getElementById('isActiveSwitch');

            // Listener for Job Status Toggles
            if (schedulerPane) {
                schedulerPane.addEventListener('change', function(e) {
                    if (e.target && e.target.classList.contains('job-active-toggle')) {
                        const jobId = e.target.dataset.jobId;
                        if (jobId) {
                            console.log(`[UI Action] Job toggle changed: ${jobId}, Active: ${e.target.checked}`);
                            updateJobActiveStatus(jobId, e.target.checked); // Use updated function name
                        }
                    }
                });
            }

            // Listener for Schedule Update Buttons
            if (schedulerPane) {
                schedulerPane.addEventListener('click', function(e) {
                    // Use matches() for cleaner check
                    if (e.target && e.target.matches('button.schedule-update-btn')) {
                        const jobId = e.target.dataset.jobId;
                        const inputId = e.target.dataset.inputId;
                        if (jobId && inputId) {
                            updateGenericSchedule(jobId, inputId);
                        }
                    }
                });
            }

            // Listener for Rule Status Toggles within DataTable body
            // Use jQuery delegation since DataTable manages the tbody content
            if (rulesTableBody) {
                $(rulesTableBody).on('change', '.rule-active-toggle', function() {
                    const ruleId = $(this).data('rule-id');
                    const isActive = $(this).prop('checked');
                    console.log(`[UI Action] Rule toggle changed: ${ruleId}, Active: ${isActive}`);
                    updateRuleActiveStatus(ruleId, isActive);
                });
            }

            // Listener for Add Rule Button click
            if (rulesPane) { // Listen on a static parent
                rulesPane.addEventListener('click', function(e) {
                     if (e.target && e.target.matches('button.add-rule-btn')) {
                        prepareAddRuleModal();
                     }
                 });
            }

            // Listener for Rule Form Submission
             if (ruleForm) {
                 ruleForm.addEventListener('submit', handleRuleSubmit);
             }

             // Listener for Modal Hidden event (to reset form)
             if (ruleModal) {
                 ruleModal.addEventListener('hidden.bs.modal', resetRuleForm);
             }
             
             // Listener for modal switch change to sync hidden field
             if (isActiveSwitch) {
                 isActiveSwitch.addEventListener('change', function() {
                    document.getElementById('isActiveHidden').value = this.checked ? 'true' : 'false';
                 });
             }

             // Listener for Edit/Delete buttons in DataTable body
             // Use jQuery delegation since DataTable manages the tbody content
             if (rulesTableBody) {
                 $(rulesTableBody).on('click', 'button', function(e) {
                     const button = $(this);
                     const row = button.closest('tr');
                     const rowData = rulesDataTable.row(row).data();

                     if (!rowData) {
                         console.error("Could not get row data for button click.");
                         showAlert("Action failed: Could not identify rule.", "danger");
                         return;
                     }

                     const ruleId = rowData[0]; // Get ID from data array

                     if (button.hasClass('btn-edit')) {
                         console.log(`[UI Action] Edit button clicked for rule ID: ${ruleId}`);
                         // Reconstruct rule object from row data array
                         const rule = {
                             id: rowData[0],
                             rule_name: rowData[1],
                             min_value: rowData[2],
                             max_value: rowData[3],
                             description: rowData[4],
                             // Get the raw status string ('Active'/'Inactive') and convert to boolean
                             is_active: (rowData[5] === 'Active') 
                         };
                         prepareEditRuleModal(rule); // Pass the reconstructed object

                     } else if (button.hasClass('btn-delete')) {
                         console.log(`[UI Action] Delete button clicked for rule ID: ${ruleId}`);
                         // Find the rule ID directly from the row data
                         deleteRule(ruleId); // Pass only the ID
                     }
                 });
            }

            // --- Theme Change Listener --- 
            window.addEventListener('themeChanged', function(e) {
                console.log('[Config] Theme changed event received:', e.detail.theme);
                const theme = e.detail.theme;
                const tableElement = document.querySelector('#rulesTable');
                if (tableElement) {
                    if (theme === 'dark') {
                        tableElement.classList.add('table-dark');
                    } else {
                        tableElement.classList.remove('table-dark');
                    }
                }
            });
            // Apply initial theme class to table on load
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                document.querySelector('#rulesTable')?.classList.add('table-dark');
            }
            // --- End Theme Change Listener --- 

            // --- Load initial notification settings ---
            loadTelegramSettings(); 
            loadTaskNotificationSettings();
            // --- End Load initial notification settings ---

            // --- Attach listeners for notification forms/buttons ---
            const telegramConfigForm = document.getElementById('telegramConfigForm');
            if (telegramConfigForm) {
                telegramConfigForm.addEventListener('submit', handleTelegramConfigSave);
            }
            const sendTestTelegramBtn = document.getElementById('sendTestTelegramBtn');
            if (sendTestTelegramBtn) {
                sendTestTelegramBtn.addEventListener('click', sendTestTelegramNotification);
            }
            const telegramNotificationsActiveSwitch = document.getElementById('telegram-notifications-active-switch');
            if (telegramNotificationsActiveSwitch) {
                telegramNotificationsActiveSwitch.addEventListener('change', handleTelegramActiveToggle);
            }
            // --- End Notification Listeners ---

            // --- Attach listeners for task notification toggles ---
            const notificationsPane = document.getElementById('notifications-pane');
            if (notificationsPane) {
                notificationsPane.addEventListener('change', function(e) {
                    if (e.target && e.target.classList.contains('task-notification-toggle')) {
                        handleTaskNotificationToggle(e);
                    }
                });
            }
            // --- End task notification listeners ---

            console.log("[DEBUG Config] DOMContentLoaded listeners set up.");
        }); // --- End DOMContentLoaded ---

        // --- NEW: CRON Description Tooltip Logic ---
        function getCronDescription(cronValue) {
            if (typeof cronstrue === 'undefined') {
                console.warn('cronstrue library is not loaded.');
                return 'CRON parser not loaded.';
            }
            if (!cronValue || cronValue.trim() === '') {
                return 'Enter a CRON expression.';
            }
            try {
                // Example options for cronstrue, customize as needed
                const options = { 
                    use24HourTimeFormat: true,
                    verbose: false, // Set to true for more detailed descriptions
                    throwExceptionOnParseError: true 
                };
                return cronstrue.toString(cronValue.trim(), options);
            } catch (e) {
                return e.message || 'Invalid CRON syntax.';
            }
        }

        function initializeCronDescriptionTooltips() {
            const cronInputs = document.querySelectorAll('.cron-input-hover-description');
            cronInputs.forEach(inputEl => {
                // Initialize Bootstrap Tooltip
                const tooltipInstance = new bootstrap.Tooltip(inputEl, {
                    title: getCronDescription(inputEl.value), // Initial title
                    trigger: 'hover focus', // Show on hover and focus
                    placement: 'top',       // Adjust placement as needed
                    customClass: 'cron-description-tooltip' // Optional custom class for styling
                });

                // Update tooltip content on input change
                inputEl.addEventListener('input', function() {
                    const newDescription = getCronDescription(this.value);
                    tooltipInstance.setContent({ '.tooltip-inner': newDescription });
                });

                // Optional: Update on focus as well if content might change externally
                // inputEl.addEventListener('focus', function() {
                //     const newDescription = getCronDescription(this.value);
                //     tooltipInstance.setContent({ '.tooltip-inner': newDescription });
                // });
            });
        }
        // --- END: CRON Description Tooltip Logic ---

        // --- DataTable Initialization --- 
        function initializeRulesTable() {
            // Parse initial data
            let initialRulesData = [];
            const rawJsonElement = document.getElementById('initial-rules-data');
            const rawJsonContent = rawJsonElement ? rawJsonElement.textContent : '[]';
            console.log("Raw JSON content from script tag:", rawJsonContent); // Log raw content
            try {
                 initialRulesData = JSON.parse(rawJsonContent);
                 console.log("Parsed initial rules data:", initialRulesData);
            } catch (e) {
                 console.error("Error parsing initial rules JSON:", e, "\nRaw content was:\n", rawJsonContent); // Log raw content on error
                 showAlert("Error loading initial rules data.", "danger");
            }
            
            // Map initial data to the format expected by DataTables columns
            const initialTableData = initialRulesData.map(rule => createRowDataArray(rule));
            
            setTimeout(function() {
                console.log("Initializing DataTables...");
                // --- UNCOMMENT AND UPDATE DATATABLES INIT ---
                rulesDataTable = $('#rulesTable').DataTable({
                    data: initialTableData, // Use parsed initial data
                    columns: [ // Define columns explicitly
                         { data: 0, title: "ID" }, 
                         { data: 1, title: "Rule Name" }, 
                         { data: 2, title: "Min Value" }, 
                         { data: 3, title: "Max Value" }, 
                         { data: 4, title: "Description" }, 
                         { 
                             data: 5, title: "Status", type: 'string',
                             render: function(data, type, row, meta) {
                                 const isActive = (data === 'Active');
                                 if (type === 'display') {
                                     const ruleId = row[0]; // Get ID from the row data array
                                     const ruleName = row[1];
                                     if (ruleId !== undefined && ruleName !== undefined) {
                                         // Generate standard Bootstrap 5 switch HTML
                                         const switchId = `rule-active-switch-${ruleId}`; // Unique ID
                                         const switchHtml = `
                                            <div class="form-check form-switch d-flex justify-content-center align-items-center">
                                                <input class="form-check-input rule-active-toggle" 
                                                       type="checkbox" 
                                                       role="switch" 
                                                       id="${switchId}" 
                                                       data-rule-id="${ruleId}" 
                                                       data-rule-name="${ruleName}" 
                                                       ${isActive ? 'checked' : ''}>
                                            </div>
                                         `;
                                         return switchHtml;
                                     } else { return data; }
                                 } 
                                 return data; 
                             }
                         },
                         { 
                             data: 6, title: "Actions", orderable: false, 
                             // Render function for buttons if needed, or rely on createRowDataArray setting HTML
                             // defaultContent might also work if buttonsHTML is consistent
                             render: function(data, type, row, meta) {
                                  // Data for this column is the buttonsHTML string from createRowDataArray
                                  return data; 
                             }
                         }
                    ],
                    pageLength: 10, 
                    order: [[1, 'asc']], 
                    columnDefs: [
                        // Keep existing columnDefs for non-orderable columns if needed,
                        // but target indices might need adjustment if column order changed
                        { targets: [0, 2, 3, 4, 6], orderable: false }, 
                        // Render/type defs are now part of the 'columns' array
                    ],
                    createdRow: function(row, data, dataIndex) {
                        // Find the toggle checkbox within the newly created row and initialize it
                        // const toggleCheckbox = $(row).find('.rule-active-toggle'); // No longer need toggleCheckbox var
                        // if (toggleCheckbox.length) { // Check no longer needed
                            // console.log(`Initializing toggle in createdRow for row index ${dataIndex}`);
                            // toggleCheckbox.bootstrapToggle(); // REMOVED bootstrap-toggle initialization
                        // } else { // Else no longer needed
                            // console.log(`No toggle found in createdRow for row index ${dataIndex}`);
                        // } // End if/else
                    },
                    initComplete: function(settings, json) {
                        console.log('[DEBUG Config] DataTables initComplete.');
                        // Apply initial theme class (redundant with DOMContentLoaded one, but safe)
                        if (document.documentElement.getAttribute('data-theme') === 'dark') {
                            $('#rulesTable').addClass('table-dark');
                        }
                        addTableFilters(this.api());
                    }
                }); // End DataTable Init
                console.log("DataTables Initialized.");
                
                // Add filters after init
                addTableFilters(rulesDataTable);

                // REMOVE explicit call for initial draw - Rely on createdRow
                // initializeToggles();

            }, 0); // End setTimeout wrapper for DT init
        }
        
        // --- Add Filters to DataTable Header ---
        function addTableFilters(dataTableApi) {
             console.log("Adding table filters...");
             // --- Dynamically create the filter row --- 
             var filterRow = $('<tr class="filter-row"></tr>');
             dataTableApi.columns().every(function() {
                 filterRow.append('<th></th>'); 
             });
             $('#rulesTable thead').append(filterRow);
             // --- End filter row creation ---

             // --- Add filter widgets --- 
             dataTableApi.columns().every(function() {
                 var column = this;
                 var columnIndex = column.index();
                 var filterCell = $('#rulesTable thead .filter-row th').eq(columnIndex);
                 
                 if (!filterCell.length) return; 

                 // --- Rule Name Text Filter (Column 1) ---
                 if (columnIndex === 1) { 
                      filterCell.html('<input type="text" class="form-control form-control-sm" placeholder="Filter Rule Name" />');
                      $('input', filterCell).on('keyup change clear', function() {
                          if (column.search() !== this.value) {
                              column.search(this.value).draw();
                          }
                      });
                 }
                 // --- Status Dropdown Filter (Column 5) ---
                 else if (columnIndex === 5) { 
                     var select = $('<select class="form-select form-select-sm"><option value="">All Statuses</option></select>')
                         .appendTo(filterCell.empty()) 
                         .on('change', function() { 
                             var val = $(this).val();
                             column.search(val ? '^' + $.fn.dataTable.util.escapeRegex(val) + '$' : '', true, false).draw(); 
                         });
                     ['Active', 'Inactive'].forEach(function(status) { 
                         select.append('<option value="' + status + '">' + status + '</option>');
                     });
                 }
             });
             console.log("Table filters added.");
        }

        // --- Modal Handling ---
        function prepareAddRuleModal() {
            resetRuleForm();
            $('#ruleModalLabel').text('Add New Rule');
            // Clear form action (it will be determined during submit)
            // $('#ruleForm').attr('action', ""); 
            $('#saveRuleButton').text('Add Rule');
        }

        function prepareEditRuleModal(rule) { // Expects parsed JS object
            resetRuleForm();
            $('#ruleModalLabel').text(`Edit Rule (ID: ${rule.id})`);

            $('#ruleId').val(rule.id);
            $('#ruleName').val(rule.rule_name);
            $('#minValue').val(rule.min_value);
            $('#maxValue').val(rule.max_value);
            $('#description').val(rule.description || '');

            // Ensure boolean comparison for is_active
            const isActive = rule.is_active === true; 
             // REMOVE bootstrapToggle() calls
             $('#isActiveSwitch').prop('checked', isActive);
             $('#isActiveHidden').val(isActive ? 'true' : 'false');

            $('#saveRuleButton').text('Update Rule');

            // Get or create the modal instance safely
            var ruleModalElement = document.getElementById('ruleModal');
            var ruleModal = bootstrap.Modal.getInstance(ruleModalElement);
            if (!ruleModal) {
                ruleModal = new bootstrap.Modal(ruleModalElement);
            }
            ruleModal.show();
        }

        function resetRuleForm() {
            $('#ruleForm')[0].reset(); // Reset native form elements
            $('#ruleId').val(''); // Clear hidden ID
            $('#ruleName').val(''); // Reset select
            $('#minValue').val('0.0');
            $('#maxValue').val('0.0');
            $('#description').val('');
            // Reset the toggle switch visually and the hidden field - REMOVE bootstrapToggle() calls
            $('#isActiveSwitch').prop('checked', true);
            $('#isActiveHidden').val('true');
        }

        // --- Rule Form Submission (using Fetch API) ---
        async function handleRuleSubmit(event) {
            event.preventDefault(); // Stop traditional form submission

            const form = event.target;
            const ruleId = document.getElementById('ruleId').value;
            const isUpdate = !!ruleId;
            // Determine URL based on whether it's an update or add - Use /api/ path
            const url = isUpdate ? `/api/rules/update` : `/api/rules/add`;
            const method = 'POST';

            const formData = new FormData(form);
            // Convert FormData to a plain object suitable for JSON
             const data = Object.fromEntries(formData.entries());

            // Ensure correct boolean value for is_active from the hidden field
             data.is_active = data.is_active === 'true';

             // Convert numbers
             data.min_value = parseFloat(data.min_value);
             data.max_value = parseFloat(data.max_value);

             // Add rule_id to the payload ONLY for updates
             if (isUpdate) {
                 data.rule_id = parseInt(ruleId); // Make sure it's an integer
             }

             // Basic validation: min <= max
             if (data.min_value > data.max_value) {
                 showAlert('Min Value cannot be greater than Max Value.', 'warning');
                 return; // Stop submission
             }

            console.log("Submitting to:", url, "Data:", data);

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json', // Sending JSON
                        'Accept': 'application/json' // Expecting JSON back
                    },
                     body: JSON.stringify(data) // Send data as JSON string
                });

                const result = await response.json(); // Assume backend returns JSON

                if (!response.ok) {
                     // Use detailed error from backend if available
                    throw new Error(result.detail || result.error || `Request failed with status ${response.status}`);
                }

                showAlert(result.message || (isUpdate ? 'Rule updated successfully!' : 'Rule added successfully!'), 'success');

                 // Update table using the full list returned from backend
                 if (result.all_rules) {
                    updateRulesTable(result.all_rules);
                 } else {
                     // Fallback if full list isn't returned (should not happen with current backend)
                     console.warn("Backend did not return all_rules, performing individual update/add.");
                     if (isUpdate && result.rule) {
                        updateTableRow(result.rule);
                     } else if (!isUpdate && result.rule) {
                        addTableRow(result.rule);
                     } else {
                        window.location.reload(); // Last resort
                     }
                 }

                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('ruleModal')).hide();

            } catch (error) {
                console.error("Error saving rule:", error);
                showAlert(`Error: ${error.message}`, 'danger');
            }
        }

        // --- Update Active Status via Fetch ---
        async function updateRuleActiveStatus(ruleId, isActive) {
             console.log(`[START] updateRuleActiveStatus called for rule ${ruleId} to ${isActive}`); // Added log
             // Use the correct API endpoint path
             const url = `/api/rules/update`; // Use the main JSON update endpoint
             const data = {
                 rule_id: ruleId, // Send ID in body as expected by PortfolioRuleUpdate model
                 is_active: isActive
             };

             try {
                 const response = await fetch(url, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Accept': 'application/json'
                     },
                     body: JSON.stringify(data)
                 });

                 const result = await response.json();

                 if (!response.ok) {
                     throw new Error(result.detail || result.error || `HTTP error ${response.status}`);
                 }

                 showAlert(result.message || `Rule ${ruleId} status updated.`, 'success');

                 // Redraw the table completely to reflect any side-effects (like deactivation)
                 if (result.all_rules) {
                     updateRulesTable(result.all_rules);
                 } else {
                     console.warn("Backend did not return all rules after toggle, reloading page.");
                     // window.location.reload(); // COMMENT OUT page reload on error
                 }

             } catch (error) {
                 console.error('Error updating rule status:', error);
                 showAlert(`Error updating status: ${error.message}`, 'danger');
                 // Consider reloading page to revert toggle visually on error
                 // window.location.reload(); // COMMENT OUT page reload on error
             }
        }

        // --- Delete Rule via Fetch ---
        async function deleteRule(ruleId) { // Takes ID directly now
             if (!confirm(`Are you sure you want to delete Rule ID ${ruleId}? This cannot be undone.`)) {
                 return;
             }
             console.log(`Attempting to delete rule ID: ${ruleId}`);
             // Use the correct API endpoint path
             const url = `/api/rules/delete`; 
             const data = { rule_id: ruleId }; 

             try {
                 const response = await fetch(url, {
                     method: 'POST', 
                     headers: {
                         'Content-Type': 'application/json',
                         'Accept': 'application/json'
                     },
                     body: JSON.stringify(data)
                 });

                 const result = await response.json();

                 if (!response.ok) {
                     throw new Error(result.detail || result.error || `HTTP error ${response.status}`);
                 }

                 showAlert(result.message || `Rule ${ruleId} deleted successfully.`, 'success');
                 
                 // --- DataTables: Remove row using the button's parent row --- 
                 var table = $('#rulesTable').DataTable();
                 var rowNode = $(`#rule-row-${ruleId}`).get(0); // Get the DOM node
                 if(rowNode) {
                     table.row(rowNode).remove().draw(false); // Use DOM node with DataTables API
                     console.log(`Row node for rule ${ruleId} removed.`);
                 } else {
                      console.error(`Could not find row node for rule ${ruleId} to remove.`);
                      // Fallback: attempt removal by ID selector if node not found (less reliable)
                      // table.row($(`#rule-row-${ruleId}`)).remove().draw(false);
                 }
                 
                 // Check if table is now empty (after draw)
                 if (table.rows().count() === 0) {
                     // Optionally add back the 'no rules' row if desired, 
                     // but DataTables has its own empty table message.
                     // $('#rulesTableBody').html('<tr id="no-rules-row"><td colspan="7" class="text-center">No portfolio rules defined yet.</td></tr>');
                 }

             } catch (error) {
                 console.error('Error deleting rule:', error);
                 showAlert(`Error deleting rule ${ruleId}: ${error.message}`, 'danger');
             }
        }

        // --- Update Rules Table (Replaces rows) --- 
        function updateRulesTable(rules) {
             console.log("Updating rules table with new data...");
             var table = $('#rulesTable').DataTable();
             
             table.clear();
             
             if (rules && rules.length > 0) {
                 const tableData = rules.map(rule => createRowDataArray(rule));
                 table.rows.add(tableData); 
             } 
             
             // Draw the table - drawCallback will handle toggle init for new rows
             table.draw(false); 
             console.log("Table redrawn.");
         }

        // Helper function to create array data for a DataTables row
        function createRowDataArray(rule) {
             const isActive = rule.is_active === true || rule.is_active === 1 || `${rule.is_active}`.toLowerCase() === 'true';
             const description = rule.description || '';
             // REMOVE ruleJsonString creation - no longer needed for inline onclick

             // Create ONLY buttons HTML string here - REMOVE TEXT, ADD TOOLTIPS
             // Add data-rule-id attribute for easier identification if needed, although we get it from the row now
             const buttonsHtml = `                 <button class="btn btn-primary btn-sm btn-edit"
                         data-rule-id="${rule.id}"
                         title="Edit Rule">
                     <i class="bi bi-pencil-square"></i>
                 </button>
                 <button class="btn btn-danger btn-sm btn-delete"
                         data-rule-id="${rule.id}"
                         title="Delete Rule">
                      <i class="bi bi-trash"></i>
                 </button>
             `; // NOTE: deleteRule is handled by the delegated listener now, so onclick is removed here too.

             return [
                 rule.id,
                 rule.rule_name,
                 rule.min_value,
                 rule.max_value,
                 description,
                 isActive ? 'Active' : 'Inactive', // Return simple string for Status column
                 buttonsHtml
             ];
         }
         
        // Helper function to create HTML for a table row (Alternative - used by updateRulesTable now)
        function createTableRow(rule) { // This function is likely NO LONGER USED directly
             // ... (keep for reference or remove if confident) ...
             const isActive = rule.is_active === true || rule.is_active === 1 || `${rule.is_active}`.toLowerCase() === 'true';
             const description = rule.description || ''; // Handle null
             // REMOVE ruleJsonString creation
             // REMOVE inline onclick handlers for edit/delete

             return `
                 <tr id="rule-row-${rule.id}" data-rule-id="${rule.id}">
                     <td>${rule.id}</td>
                     <td class="rule-name">${rule.rule_name}</td>
                     <td class="min-value">${rule.min_value}</td>
                     <td class="max-value">${rule.max_value}</td>
                     <td class="description">${description}</td>
                     <td data-order="${isActive ? 'Active' : 'Inactive'}" data-filter="${isActive ? 'Active' : 'Inactive'}">
                         {/* Switch HTML generation moved to DataTable column render function */}
                         ${isActive ? 'Active' : 'Inactive'} {/* Placeholder */}
                     </td>
                     <td>
                         <button class="btn btn-primary btn-sm btn-edit" data-rule-id="${rule.id}" title="Edit Rule">
                             <i class="bi bi-pencil-square"></i>
                         </button>
                         <button class="btn btn-danger btn-sm btn-delete" data-rule-id="${rule.id}" title="Delete Rule">
                              <i class="bi bi-trash"></i>
                         </button>
                     </td>
                 </tr>
             `;
          }

        // --- NEW Function to Update Job Active Status via Fetch ---
        async function updateJobActiveStatus(jobId, isActive) { // Renamed from updateJobStatus
            const url = '/config/schedule/update_status';
            const data = { job_id: jobId, is_active: isActive };

            console.log(`[DEBUG Config] Sending job status update for ${jobId}:`, JSON.stringify(data));

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || `Request failed: ${response.status}`);
                
                showAlert(result.message || `Job ${jobId} status updated.`, 'success');
                
            } catch (error) {
                console.error(`[DEBUG Config] Error updating status for ${jobId}:`, error);
                showAlert(`Error updating ${jobId} status: ${error.message}`, 'danger');
                // Revert toggle visually?
                const toggleInput = document.getElementById(`${jobId.replace('_','-')}-active-switch`);
                if (toggleInput) toggleInput.checked = !isActive;
            }
        }

        // --- Helper Function for JS Interval Formatting ---
        function intervalSecondsToHumanJS(seconds) {
            if (seconds === null || seconds === undefined || seconds <= 0) {
                return "Not Set";
            }
            
            if (seconds % 86400 === 0) {
                const days = seconds / 86400;
                return `${days} day${days > 1 ? 's' : ''}`;
            }
            if (seconds % 3600 === 0) {
                const hours = seconds / 3600;
                return `${hours} hour${hours > 1 ? 's' : ''}`;
            }
            if (seconds % 60 === 0) {
                 const minutes = seconds / 60;
                 return `${minutes} minute${minutes > 1 ? 's' : ''}`;
            }
            
            return `${seconds} second${seconds > 1 ? 's' : ''}`; // Default to seconds
        }
        // --- End Helper Function ---

        // --- NEW Function to Update Generic Schedule via Fetch ---
        async function updateGenericSchedule(jobId, inputId) {
            const scheduleInput = document.getElementById(inputId);
            if (!scheduleInput) {
                showAlert(`Error: Input element with ID '${inputId}' not found.`, 'danger');
                return;
            }
            const scheduleValue = scheduleInput.value.trim();
            const displaySpan = document.getElementById(`current-${jobId}-schedule`); // Use full job ID

            if (!scheduleValue) {
                showAlert('Schedule input cannot be empty.', 'warning');
                return;
            }

            // Validate cron syntax for ALL jobs now, not just 'yahoo_data_fetch'
            const cronRegex = /^(\*|[0-9]{1,2}|\*\/[0-9]{1,2})(\s+(\*|[0-9]{1,2}|\*\/[0-9]{1,2})){4}$/;
            if (!cronRegex.test(scheduleValue)) {
                showAlert('Invalid cron syntax. Please use standard 5-field format (e.g., "0 */2 * * *"). Link to crontab.guru for help.', 'warning');
                return;
            }

            const url = '/config/schedule/generic_update';
            const data = { job_id: jobId, schedule: scheduleValue };

            console.log(`Updating generic schedule for ${jobId} with input: '${scheduleValue}'`);

            try {
                const response = await fetch(url, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || `Request failed: ${response.status}`);
                
                showAlert(result.message || `Schedule updated for ${jobId}!`, 'success');
                
                // Update the display span with the schedule value
                if (displaySpan && result.cron_schedule) { // Check if cron_schedule exists in response
                    displaySpan.textContent = result.cron_schedule; // Use cron_schedule from response
                    console.log(`Updated display span #${displaySpan.id} to: ${displaySpan.textContent}`);
                } else if (displaySpan) { // Fallback if cron_schedule not in response (should not happen)
                    displaySpan.textContent = scheduleValue;
                     console.warn(`Display span for ${jobId} updated with input value as fallback. Response was:`, result);
                } else {
                    console.warn(`Display span for ${jobId} not found.`);
                }

            } catch (error) {
                console.error(`Error updating ${jobId}:`, error);
                showAlert(`Error updating ${jobId} schedule: ${error.message}`, 'danger');
            }
        }
        // --- End NEW Function ---

        // --- NEW: runJobNow Function ---
        async function runJobNow(apiUrl, jobName, buttonElement) {
            if (!confirm(`Are you sure you want to run the job '${jobName}' now?`)) {
                return;
            }

            const originalButtonText = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running...';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        // No 'Content-Type' needed for an empty POST body if your backend handles it.
                        // If your backend expects 'application/json' even for empty body, add:
                        // 'Content-Type': 'application/json',
                    }
                    // body: JSON.stringify({}), // If your POST endpoint expects a JSON body, even an empty one.
                });

                const result = await response.json(); // Assuming backend returns JSON

                if (!response.ok) {
                    // Try to get detail from FastAPI's HTTPException, or a generic message
                    const errorMessage = result.detail || result.message || `Request failed with status ${response.status}`;
                    throw new Error(errorMessage);
                }

                showAlert(`${jobName} triggered successfully. Status: ${response.status}. Message: ${result.message || 'OK'}`, 'success');

            } catch (error) {
                console.error(`Error running job ${jobName}:`, error);
                showAlert(`Failed to trigger ${jobName}: ${error.message || 'Unknown error'}`, 'danger');
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonText;
            }
        }
        // --- END: runJobNow Function ---

        // --- START TELEGRAM NOTIFICATION FUNCTIONS ---
        async function loadTelegramSettings() {
            try {
                const response = await fetch('/api/notifications/telegram/settings');
                if (!response.ok) {
                    if (response.status === 404) { // Settings not found is ok, just means not configured
                        console.info('Telegram settings not found. Forms will be empty.');
                        document.getElementById('telegramBotToken').value = '';
                        document.getElementById('telegramChatId').value = '';
                        document.getElementById('telegram-notifications-active-switch').checked = false;
                        return;
                    }
                    throw new Error(`Failed to load Telegram settings: ${response.status}`);
                }
                const data = await response.json();
                if (data && data.settings) {
                    document.getElementById('telegramBotToken').value = data.settings.bot_token || '';
                    document.getElementById('telegramChatId').value = data.settings.chat_id || '';
                }
                document.getElementById('telegram-notifications-active-switch').checked = data.is_active || false;

            } catch (error) {
                console.error('Error loading Telegram settings:', error);
                showAlert('Could not load Telegram settings.', 'danger');
            }
        }

        async function handleTelegramConfigSave(event) {
            event.preventDefault();
            const botToken = document.getElementById('telegramBotToken').value;
            const chatId = document.getElementById('telegramChatId').value;
            const isActive = document.getElementById('telegram-notifications-active-switch').checked;

            if (!botToken || !chatId) {
                showAlert('Bot Token and Chat ID are required to save Telegram settings.', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/notifications/telegram/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ bot_token: botToken, chat_id: chatId, is_active: isActive })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Failed to save settings');
                showAlert(result.message || 'Telegram settings saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving Telegram settings:', error);
                showAlert(`Error: ${error.message}`, 'danger');
            }
        }

        async function handleTelegramActiveToggle(event) {
            const isActive = event.target.checked;
            try {
                const response = await fetch('/api/notifications/telegram/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ is_active: isActive })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Failed to update status');
                showAlert(result.message || `Telegram notifications ${isActive ? 'activated' : 'deactivated'}.`, 'success');
                 // If activating and form was empty, it might be good to reflect that settings are now "initialized"
                 // This is handled by the save endpoint if called explicitly, or by the status endpoint now.
                 // Refresh settings to ensure UI is consistent if backend initializes empty settings on activate.
                 if (isActive) {
                    loadTelegramSettings(); // Refresh to get potentially initialized (empty) settings if backend does this
                 }
            } catch (error) {
                console.error('Error updating Telegram active status:', error);
                showAlert(`Error: ${error.message}`, 'danger');
                event.target.checked = !isActive; // Revert toggle on error
            }
        }

        async function sendTestTelegramNotification() {
            const button = document.getElementById('sendTestTelegramBtn');
            const originalButtonText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';

            try {
                const response = await fetch('/api/notifications/telegram/test', { method: 'POST', headers: { 'Accept': 'application/json' } });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Failed to send test message');
                showAlert(result.message || 'Test notification sent successfully!', 'success');
            } catch (error) {
                console.error('Error sending test Telegram notification:', error);
                showAlert(`Error: ${error.message}`, 'danger');
            } finally {
                button.disabled = false;
                button.innerHTML = originalButtonText;
            }
        }
        // --- END TELEGRAM NOTIFICATION FUNCTIONS ---

        // --- START TASK-SPECIFIC NOTIFICATION FUNCTIONS ---
        
        // NEW: Function to define tasks and populate the UI
        function populateTaskNotificationToggles() {
            const taskContainer = document.getElementById('task-notification-list');
            if (!taskContainer) return;

            // Define the list of tasks here
            const taskInfo = [
                { id: 'finviz_mass_fetch', name: 'Finviz Mass Fetch (User-Triggered)' },
                { id: 'yahoo_mass_fetch', name: 'Yahoo Mass Fetch (User-Triggered)' },
                { id: 'scheduled_ibkr_data', name: 'Scheduled IBKR Data Fetch' },
                { id: 'scheduled_ibkr_snapshot', name: 'Scheduled IBKR Snapshot' },
                { id: 'scheduled_finviz_data', name: 'Scheduled Finviz Data Fetch' },
                { id: 'scheduled_yahoo_data', name: 'Scheduled Yahoo Data Fetch' },
                { id: 'scheduled_analytics_data_refresh', name: 'Scheduled Analytics Data Refresh' },
                { id: 'scheduled_analytics_metadata_refresh', name: 'Scheduled Analytics Metadata Refresh' }
            ];

            let content = '';
            taskInfo.forEach(task => {
                content += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${task.name}</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input task-notification-toggle" type="checkbox" role="switch" id="task-notify-${task.id}" data-task-id="${task.id}" data-bs-toggle="tooltip" data-bs-placement="left" title="Enable/Disable notifications for this task">
                            <label class="form-check-label" for="task-notify-${task.id}"></label>
                        </div>
                    </li>
                `;
            });

            taskContainer.innerHTML = content;
            
            // Re-initialize tooltips for the newly added elements
            const newTooltipTriggerList = [].slice.call(taskContainer.querySelectorAll('[data-bs-toggle="tooltip"]'));
            newTooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Load the settings for these new toggles
            loadTaskNotificationSettings();
        }

        async function loadTaskNotificationSettings() {
            try {
                const response = await fetch('/api/notifications/task_settings');
                if (!response.ok) {
                    // It's okay if settings don't exist yet (404), just means nothing is configured.
                    if (response.status === 404) {
                        console.info('Task notification settings not found. Toggles will be off.');
                        document.querySelectorAll('.task-notification-toggle').forEach(toggle => {
                            toggle.checked = false;
                        });
                        return;
                    }
                    throw new Error(`Failed to load task notification settings: ${response.status}`);
                }
                const settings = await response.json();
                
                // Loop through all toggles and set their state based on the response
                document.querySelectorAll('.task-notification-toggle').forEach(toggle => {
                    const taskId = toggle.dataset.taskId;
                    if (settings && typeof settings[taskId] !== 'undefined') {
                        toggle.checked = settings[taskId];
                    } else {
                        toggle.checked = false; // Default to off if not specified
                    }
                });
                console.log('Task notification settings loaded.');

            } catch (error) {
                console.error('Error loading task notification settings:', error);
                showAlert('Could not load task notification settings.', 'warning');
            }
        }

        async function handleTaskNotificationToggle(event) {
            const taskId = event.target.dataset.taskId;
            const isActive = event.target.checked;
            
            console.log(`Toggling task notification for ${taskId} to ${isActive}`);

            try {
                const response = await fetch('/api/notifications/task_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ task_id: taskId, is_active: isActive })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Failed to update task notification setting');
                showAlert(result.message || `Notification setting for '${taskId}' updated.`, 'success');
            } catch (error) {
                console.error('Error saving task notification setting:', error);
                showAlert(`Error: ${error.message}`, 'danger');
                event.target.checked = !isActive; // Revert toggle on error
            }
        }
        // --- END TASK-SPECIFIC NOTIFICATION FUNCTIONS ---

    </script>
    {% endraw %}
{% endblock %} {# End Scripts Block #}

